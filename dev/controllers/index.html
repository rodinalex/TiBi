
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://rodinalex.github.io/TiBi/dev/controllers/">
      
      
        <link rel="prev" href="../architecture/">
      
      
        <link rel="next" href="../core/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Controllers - TiBi</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#TiBi.controllers.AppController" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TiBi" class="md-header__button md-logo" aria-label="TiBi" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TiBi
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Controllers
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/rodinalex/TiBi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../user_guide/install/" class="md-tabs__link">
          
  
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../architecture/" class="md-tabs__link">
          
  
  
  Developer Guide

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TiBi" class="md-nav__button md-logo" aria-label="TiBi" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TiBi
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rodinalex/TiBi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/bands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Band structure and DOS
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Developer Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Developer Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Controllers
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Controllers
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.AppController" class="md-nav__link">
    <span class="md-ellipsis">
      AppController
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController" class="md-nav__link">
    <span class="md-ellipsis">
      BandsController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BandsController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.get_dos_properties" class="md-nav__link">
    <span class="md-ellipsis">
      get_dos_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.get_projection_indices" class="md-nav__link">
    <span class="md-ellipsis">
      get_projection_indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.update_bands_panel" class="md-nav__link">
    <span class="md-ellipsis">
      update_bands_panel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.update_combo" class="md-nav__link">
    <span class="md-ellipsis">
      update_combo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.BrillouinZonePlotController" class="md-nav__link">
    <span class="md-ellipsis">
      BrillouinZonePlotController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BrillouinZonePlotController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.BrillouinZonePlotController.update_brillouin_zone" class="md-nav__link">
    <span class="md-ellipsis">
      update_brillouin_zone
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController" class="md-nav__link">
    <span class="md-ellipsis">
      ComputationController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ComputationController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.get_dos_properties" class="md-nav__link">
    <span class="md-ellipsis">
      get_dos_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.get_pair_selection" class="md-nav__link">
    <span class="md-ellipsis">
      get_pair_selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.get_projection_indices" class="md-nav__link">
    <span class="md-ellipsis">
      get_projection_indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.update_bands_panel" class="md-nav__link">
    <span class="md-ellipsis">
      update_bands_panel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.update_hopping_panel" class="md-nav__link">
    <span class="md-ellipsis">
      update_hopping_panel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.update_projection_combo" class="md-nav__link">
    <span class="md-ellipsis">
      update_projection_combo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.hopping_controller.HoppingController" class="md-nav__link">
    <span class="md-ellipsis">
      HoppingController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HoppingController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.hopping_controller.HoppingController.update_unit_cell" class="md-nav__link">
    <span class="md-ellipsis">
      update_unit_cell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController" class="md-nav__link">
    <span class="md-ellipsis">
      MainUIController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MainUIController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController.get_uc_plot_properties" class="md-nav__link">
    <span class="md-ellipsis">
      get_uc_plot_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController.set_spinbox_status" class="md-nav__link">
    <span class="md-ellipsis">
      set_spinbox_status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController.update_status" class="md-nav__link">
    <span class="md-ellipsis">
      update_status
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.PlotController" class="md-nav__link">
    <span class="md-ellipsis">
      PlotController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PlotController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.PlotController.plot_band_structure" class="md-nav__link">
    <span class="md-ellipsis">
      plot_band_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.PlotController.plot_dos" class="md-nav__link">
    <span class="md-ellipsis">
      plot_dos
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellController" class="md-nav__link">
    <span class="md-ellipsis">
      UnitCellController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UnitCellController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellController.refresh_tree" class="md-nav__link">
    <span class="md-ellipsis">
      refresh_tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellController.select_item" class="md-nav__link">
    <span class="md-ellipsis">
      select_item
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellPlotController" class="md-nav__link">
    <span class="md-ellipsis">
      UnitCellPlotController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UnitCellPlotController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellPlotController.update_hopping_segments" class="md-nav__link">
    <span class="md-ellipsis">
      update_hopping_segments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellPlotController.update_unit_cell" class="md-nav__link">
    <span class="md-ellipsis">
      update_unit_cell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../views/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Views
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.AppController" class="md-nav__link">
    <span class="md-ellipsis">
      AppController
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController" class="md-nav__link">
    <span class="md-ellipsis">
      BandsController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BandsController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.get_dos_properties" class="md-nav__link">
    <span class="md-ellipsis">
      get_dos_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.get_projection_indices" class="md-nav__link">
    <span class="md-ellipsis">
      get_projection_indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.update_bands_panel" class="md-nav__link">
    <span class="md-ellipsis">
      update_bands_panel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.bands_controller.BandsController.update_combo" class="md-nav__link">
    <span class="md-ellipsis">
      update_combo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.BrillouinZonePlotController" class="md-nav__link">
    <span class="md-ellipsis">
      BrillouinZonePlotController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BrillouinZonePlotController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.BrillouinZonePlotController.update_brillouin_zone" class="md-nav__link">
    <span class="md-ellipsis">
      update_brillouin_zone
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController" class="md-nav__link">
    <span class="md-ellipsis">
      ComputationController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ComputationController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.get_dos_properties" class="md-nav__link">
    <span class="md-ellipsis">
      get_dos_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.get_pair_selection" class="md-nav__link">
    <span class="md-ellipsis">
      get_pair_selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.get_projection_indices" class="md-nav__link">
    <span class="md-ellipsis">
      get_projection_indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.update_bands_panel" class="md-nav__link">
    <span class="md-ellipsis">
      update_bands_panel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.update_hopping_panel" class="md-nav__link">
    <span class="md-ellipsis">
      update_hopping_panel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.ComputationController.update_projection_combo" class="md-nav__link">
    <span class="md-ellipsis">
      update_projection_combo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.hopping_controller.HoppingController" class="md-nav__link">
    <span class="md-ellipsis">
      HoppingController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HoppingController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.hopping_controller.HoppingController.update_unit_cell" class="md-nav__link">
    <span class="md-ellipsis">
      update_unit_cell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController" class="md-nav__link">
    <span class="md-ellipsis">
      MainUIController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MainUIController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController.get_uc_plot_properties" class="md-nav__link">
    <span class="md-ellipsis">
      get_uc_plot_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController.set_spinbox_status" class="md-nav__link">
    <span class="md-ellipsis">
      set_spinbox_status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.MainUIController.update_status" class="md-nav__link">
    <span class="md-ellipsis">
      update_status
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.PlotController" class="md-nav__link">
    <span class="md-ellipsis">
      PlotController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PlotController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.PlotController.plot_band_structure" class="md-nav__link">
    <span class="md-ellipsis">
      plot_band_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.PlotController.plot_dos" class="md-nav__link">
    <span class="md-ellipsis">
      plot_dos
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellController" class="md-nav__link">
    <span class="md-ellipsis">
      UnitCellController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UnitCellController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellController.refresh_tree" class="md-nav__link">
    <span class="md-ellipsis">
      refresh_tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellController.select_item" class="md-nav__link">
    <span class="md-ellipsis">
      select_item
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellPlotController" class="md-nav__link">
    <span class="md-ellipsis">
      UnitCellPlotController
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UnitCellPlotController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellPlotController.update_hopping_segments" class="md-nav__link">
    <span class="md-ellipsis">
      update_hopping_segments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TiBi.controllers.UnitCellPlotController.update_unit_cell" class="md-nav__link">
    <span class="md-ellipsis">
      update_unit_cell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Controllers</h1>

<p>This page provides the documentation for the controllers used by the Application.</p>


<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.AppController" class="doc doc-heading">
            <code>TiBi.controllers.AppController</code>


<a href="#TiBi.controllers.AppController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Main application controller.</p>
<p>This controller serves as a high-level coordinator in the application,
handling communication between different subsystems.
It connects signals from various controllers and routes requests to
appropriate handlers, ensuring that components remain decoupled from
each other.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.bz_plot_controller">bz_plot_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.BrillouinZonePlotController (TiBi.controllers.bz_plot_controller.BrillouinZonePlotController)" href="#TiBi.controllers.BrillouinZonePlotController">BrillouinZonePlotController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controller of the Broullouin zone graphical component</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.computation_controller">computation_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.ComputationController (TiBi.controllers.computation_controller.ComputationController)" href="#TiBi.controllers.ComputationController">ComputationController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controller orchestrating computations</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.main_ui_controller">main_ui_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.MainUIController (TiBi.controllers.main_ui_controller.MainUIController)" href="#TiBi.controllers.MainUIController">MainUIController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controller in charge of menus and toolbars</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.plot_controller">plot_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.PlotController (TiBi.controllers.plot_controller.PlotController)" href="#TiBi.controllers.PlotController">PlotController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controller of the results graphical component</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.uc_controller">uc_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.UnitCellController (TiBi.controllers.uc_controller.UnitCellController)" href="#TiBi.controllers.UnitCellController">UnitCellController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controller in charge of <code>UnitCell</code> creation/editing</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.AppController.uc_plot_controller">uc_plot_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.UnitCellPlotController (TiBi.controllers.uc_plot_controller.UnitCellPlotController)" href="#TiBi.controllers.UnitCellPlotController">UnitCellPlotController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controller of the <code>UnitCell</code> graphical component</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/app_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AppController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main application controller.</span>

<span class="sd">    This controller serves as a high-level coordinator in the application,</span>
<span class="sd">    handling communication between different subsystems.</span>
<span class="sd">    It connects signals from various controllers and routes requests to</span>
<span class="sd">    appropriate handlers, ensuring that components remain decoupled from</span>
<span class="sd">    each other.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    bz_plot_controller : BrillouinZonePlotController</span>
<span class="sd">        Controller of the Broullouin zone graphical component</span>
<span class="sd">    computation_controller : ComputationController</span>
<span class="sd">        Controller orchestrating computations</span>
<span class="sd">    main_ui_controller : MainUIController</span>
<span class="sd">        Controller in charge of menus and toolbars</span>
<span class="sd">    plot_controller : PlotController</span>
<span class="sd">        Controller of the results graphical component</span>
<span class="sd">    uc_controller : UnitCellController</span>
<span class="sd">        Controller in charge of `UnitCell` creation/editing</span>
<span class="sd">    uc_plot_controller : UnitCellPlotController</span>
<span class="sd">        Controller of the `UnitCell` graphical component</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">bz_plot_controller</span><span class="p">:</span> <span class="n">BrillouinZonePlotController</span><span class="p">,</span>
        <span class="n">computation_controller</span><span class="p">:</span> <span class="n">ComputationController</span><span class="p">,</span>
        <span class="n">main_ui_controller</span><span class="p">:</span> <span class="n">MainUIController</span><span class="p">,</span>
        <span class="n">plot_controller</span><span class="p">:</span> <span class="n">PlotController</span><span class="p">,</span>
        <span class="n">uc_controller</span><span class="p">:</span> <span class="n">UnitCellController</span><span class="p">,</span>
        <span class="n">uc_plot_controller</span><span class="p">:</span> <span class="n">UnitCellPlotController</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_controller</span> <span class="o">=</span> <span class="n">bz_plot_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span> <span class="o">=</span> <span class="n">computation_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span> <span class="o">=</span> <span class="n">main_ui_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_controller</span> <span class="o">=</span> <span class="n">plot_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_controller</span> <span class="o">=</span> <span class="n">uc_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_controller</span> <span class="o">=</span> <span class="n">uc_plot_controller</span>

        <span class="c1"># Connect signals</span>
        <span class="c1"># Redraw the panels only when the unit cell selection changes.</span>
        <span class="c1"># Selecting inside the unit cell should not cause redraws.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_panels</span><span class="p">)</span>
        <span class="c1"># When a new site is selected, reddraw only the unit cell plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">site_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_unit_cell_plot</span><span class="p">)</span>

        <span class="c1"># bz_plot_controller</span>
        <span class="c1"># When the path is updated, the bandstructure is cleared.</span>
        <span class="c1"># We pass an empty band structure to the plotting function</span>
        <span class="c1"># resulting in a cleared plot.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_controller</span><span class="o">.</span><span class="n">bz_path_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_bands</span><span class="p">)</span>

        <span class="c1"># computation_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relay_status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">bands_plot_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_bands</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_dos</span><span class="p">)</span>
        <span class="c1"># Handle the programmatic selection of an item in the tree</span>
        <span class="c1"># due to undo/redo in the hopping controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">selection_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_controller</span><span class="o">.</span><span class="n">select_item</span>
        <span class="p">)</span>

        <span class="c1"># Handle the request to draw hopping segments after a pair of states</span>
        <span class="c1"># is selected from the hopping button matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">hopping_segments_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_hopping_segments_requested</span>
        <span class="p">)</span>

        <span class="c1"># main_ui_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span><span class="o">.</span><span class="n">project_refresh_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_project_refresh_requested</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span><span class="o">.</span><span class="n">unit_cell_update_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_unit_cell_plot</span>
        <span class="p">)</span>
        <span class="c1"># uc_controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_controller</span><span class="o">.</span><span class="n">hopping_projection_update_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_hopping_projection_update</span>
        <span class="p">)</span>
        <span class="c1"># If site parameter changes, the change is purely cosmetic,</span>
        <span class="c1"># so the only the unit cell plot is redrawn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_controller</span><span class="o">.</span><span class="n">site_parameter_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_unit_cell_plot</span>
        <span class="p">)</span>
        <span class="c1"># Unit cell parameter changes typically invalidate</span>
        <span class="c1"># derived quantities, requiring a full redraw.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_controller</span><span class="o">.</span><span class="n">unit_cell_parameter_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_panels</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_relay_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message to the status bar.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : str</span>
<span class="sd">            Message to be show in the status bar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a full redraw of plots and panels.</span>

<span class="sd">        This major update is called when the `UnitCell` selection changes,</span>
<span class="sd">        `UnitCell` parameter changes or `Site` parameter changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

            <span class="c1"># Check which vectors of the unit cell are periodic and activate</span>
            <span class="c1"># the UC spinners if they are</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span><span class="o">.</span><span class="n">set_spinbox_status</span><span class="p">(</span>
                <span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">is_periodic</span><span class="p">,</span>
                <span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">is_periodic</span><span class="p">,</span>
                <span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">is_periodic</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Deactivate the spinners</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span><span class="o">.</span><span class="n">set_spinbox_status</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Update the 3D plots for BZ and UC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_unit_cell_plot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_controller</span><span class="o">.</span><span class="n">update_brillouin_zone</span><span class="p">()</span>

        <span class="c1"># Update the computation panels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">update_bands_panel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">update_hopping_panel</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_hopping_segments_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw hopping segments connecting the selected state pair.</span>

<span class="sd">        After a pair of states is selected from the hopping button matrix,</span>
<span class="sd">        this function passes them to the update_hopping_segments function</span>
<span class="sd">        to draw the lines connecting the source state with the destination</span>
<span class="sd">        ones. This approach avoids redrawing the rest of the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">get_pair_selection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_controller</span><span class="o">.</span><span class="n">update_hopping_segments</span><span class="p">(</span><span class="n">pair_selection</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_hopping_projection_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redraw the hopping panels and the projection dropbox.</span>

<span class="sd">        This function is necessary to make sure that the label names in the</span>
<span class="sd">        hopping matrix, hopping table, and projection drop box</span>
<span class="sd">        accurately reflect the item names. Additionally, if states are added</span>
<span class="sd">        or removed, the hopping matrix needs to be updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">update_hopping_panel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">update_projection_combo</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_project_refresh_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the selection and the tree, and do a full redraw.</span>

<span class="sd">        The unit cell dictionary and</span>
<span class="sd">        the project path have already been updated.</span>
<span class="sd">        Here, only the selection and views are refreshed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Current selection state (tracks which items are selected in the UI)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">set_selection</span><span class="p">(</span><span class="n">uc_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">site_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_controller</span><span class="o">.</span><span class="n">refresh_tree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_panels</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_unit_cell_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redraw the unit cell plot.</span>

<span class="sd">        Called during the full panels update or when site parameters change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">wireframe_shown</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_ui_controller</span><span class="o">.</span><span class="n">get_uc_plot_properties</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_controller</span><span class="o">.</span><span class="n">update_unit_cell</span><span class="p">(</span><span class="n">wireframe_shown</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span>
        <span class="c1"># If a pair of states is selected, also plot the hopping segments</span>
        <span class="n">pair_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">get_pair_selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pair_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pair_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_controller</span><span class="o">.</span><span class="n">update_hopping_segments</span><span class="p">(</span><span class="n">pair_selection</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the bands for the selected `UnitCell`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">get_projection_indices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_controller</span><span class="o">.</span><span class="n">plot_band_structure</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the DOS for the selected `UnitCell`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">get_projection_indices</span><span class="p">()</span>
        <span class="n">num_bins</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">computation_controller</span><span class="o">.</span><span class="n">get_dos_properties</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_controller</span><span class="o">.</span><span class="n">plot_dos</span><span class="p">(</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.bands_controller.BandsController" class="doc doc-heading">
            <code>TiBi.controllers.bands_controller.BandsController</code>


<a href="#TiBi.controllers.bands_controller.BandsController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller for the hopping parameter interface.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.bands_controller.BandsController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.bands_controller.BandsController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.bands_controller.BandsController.bands_panel">bands_panel</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.panels.BandsPanel" href="../views/#TiBi.views.panels.BandsPanel">BandsPanel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Main panel for bands and BZ grid calculations</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.bands_controller.BandsController.bands_plot_requested">bands_plot_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request band plots update.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.bands_controller.BandsController.dos_plot_requested">dos_plot_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request DOS plots update.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.bands_controller.BandsController.status_updated">status_updated</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span>(<span title="str">str</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Update the status bar information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_dos_properties() (TiBi.controllers.bands_controller.BandsController.get_dos_properties)" href="#TiBi.controllers.bands_controller.BandsController.get_dos_properties">get_dos_properties</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the DOS properties for the plots.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_projection_indices() (TiBi.controllers.bands_controller.BandsController.get_projection_indices)" href="#TiBi.controllers.bands_controller.BandsController.get_projection_indices">get_projection_indices</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the states selected for projection from the dropdown menu.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_bands_panel() (TiBi.controllers.bands_controller.BandsController.update_bands_panel)" href="#TiBi.controllers.bands_controller.BandsController.update_bands_panel">update_bands_panel</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Update the <code>BandsPanel</code>.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_combo() (TiBi.controllers.bands_controller.BandsController.update_combo)" href="#TiBi.controllers.bands_controller.BandsController.update_combo">update_combo</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Update the states in the combo box.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/bands_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BandsController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for the hopping parameter interface.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    bands_panel : BandsPanel</span>
<span class="sd">        Main panel for bands and BZ grid calculations</span>
<span class="sd">    bands_plot_requested : Signal</span>
<span class="sd">        Request band plots update.</span>
<span class="sd">    dos_plot_requested : Signal</span>
<span class="sd">        Request DOS plots update.</span>
<span class="sd">    status_updated : Signal(str)</span>
<span class="sd">        Update the status bar information.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_dos_properties()</span>
<span class="sd">        Get the DOS properties for the plots.</span>
<span class="sd">    get_projection_indices()</span>
<span class="sd">        Get the states selected for projection from the dropdown menu.</span>
<span class="sd">    update_bands_panel()</span>
<span class="sd">        Update the `BandsPanel`.</span>
<span class="sd">    update_combo()</span>
<span class="sd">        Update the states in the combo box.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bands_plot_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">dos_plot_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">status_updated</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">bands_panel</span><span class="p">:</span> <span class="n">BandsPanel</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span> <span class="o">=</span> <span class="n">bands_panel</span>
        <span class="c1"># Conenct the signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_bands_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_bands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_grid_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">selection_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bands_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">select_all_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">select_all</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_all_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">clear_selection</span>
        <span class="p">)</span>
        <span class="c1"># Toggle whether to show bands or DOS:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttonToggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">checked</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bands_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">checked</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Toggle between Histogram and Lorentzian.</span>
        <span class="c1"># Only trigger if DOS is selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">presentation_choice_group</span><span class="o">.</span><span class="n">buttonToggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">checked</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">checked</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Trigger plots when changing broadening or bin number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">broadening_spinbox</span><span class="o">.</span><span class="n">editingConfirmed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span>
                <span class="kc">None</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">num_bins_spinbox</span><span class="o">.</span><span class="n">editingConfirmed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span>
                <span class="kc">None</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Update the approximate output sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_band_output</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_BZ_output</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_BZ_output</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_BZ_output</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">selection_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_band_output</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">selection_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_BZ_output</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_approximate_band_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the approximate output size label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">:</span>
            <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">]</span><span class="o">.</span><span class="n">get_states</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># The multiplication by 10 is due to JSON overhead</span>
            <span class="c1"># (not being binary)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">n_pts</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">n_states</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">n_states</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">approximate_band_size</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Approximate output size: </span><span class="si">{</span><span class="n">res</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1000</span><span class="si">}</span><span class="s2"> kB&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_approximate_BZ_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the approximate output size label.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_pts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_pts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_pts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">n_pts</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">:</span>
            <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">]</span><span class="o">.</span><span class="n">get_states</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># The multiplication by 10 is due to JSON overhead</span>
            <span class="c1"># (not being binary)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">n_pts</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">n_states</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">n_states</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">approximate_BZ_grid_size</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Approximate output size: </span><span class="si">{</span><span class="n">res</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1000</span><span class="si">}</span><span class="s2"> kB&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the electronic band structure along a specified k-path.</span>

<span class="sd">        The path is defined by the special points in the Brillouin zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the radio toggle to the correct option</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">bands_radio</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Get the selected unit cell</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

        <span class="c1"># Check if the coupling is Hermitian and only then calculate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">is_hermitian</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                <span class="s2">&quot;Computation halted: the system is non-Hermitian&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Band structure calculation started...&quot;</span><span class="p">)</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="c1"># Get Hamiltonian function</span>
        <span class="n">hamiltonian_func</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">get_hamiltonian_function</span><span class="p">()</span>

        <span class="c1"># Perform calculation</span>
        <span class="n">k_path</span> <span class="o">=</span> <span class="n">interpolate_k_path</span><span class="p">(</span>
            <span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">,</span> <span class="n">num_points</span>
        <span class="p">)</span>

        <span class="c1"># Perform calculation on a separate thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">DiagonalizationWorker</span><span class="p">(</span><span class="n">hamiltonian_func</span><span class="p">,</span> <span class="n">k_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">do_work</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_band_results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span> <span class="o">=</span> <span class="n">ProgressDialog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">progress_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">update_progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_aborted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">cancel_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">request_abort</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DirectConnection</span>
        <span class="p">)</span>

        <span class="c1"># Cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_aborted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># Only show the dialog after a delay if it&#39;s still running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">maybe_show_dialog</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maybe_show_dialog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>  <span class="c1"># Delay in ms</span>

        <span class="c1"># Wait for the thread to finish and kill the timer if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_band_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the results of the band structure calculation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res : tuple[list[NDArray[np.float64]], \</span>
<span class="sd">            list[NDArray[np.float64]], list[NDArray[np.float64]]]</span>
<span class="sd">            Contains the eigenvalues, eigenvectors, and k-points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Band structure calculation completed.&quot;</span><span class="p">)</span>

        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

        <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">k_path</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">k_path</span>
        <span class="c1"># Update combo to make sure all sites are selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_combo</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the BZ grid using the settings from the panel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the radio toggle to the correct option</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">dos_radio</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Get the selected unit cell</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

        <span class="c1"># Check if the coupling is Hermitian and only then calculate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">is_hermitian</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                <span class="s2">&quot;Computation halted: the system is non-Hermitian&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;BZ grid calculation started...&quot;</span><span class="p">)</span>
        <span class="n">k_points</span> <span class="o">=</span> <span class="n">get_BZ_grid</span><span class="p">(</span>
            <span class="n">unit_cell</span><span class="o">=</span><span class="n">unit_cell</span><span class="p">,</span>
            <span class="n">n1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
            <span class="n">n2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
            <span class="n">n3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
            <span class="n">typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">grid_choice_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Get Hamiltonian function</span>
        <span class="n">hamiltonian_func</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">get_hamiltonian_function</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Computing the grid&quot;</span><span class="p">)</span>
        <span class="c1"># Perform calculation on a separate thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">DiagonalizationWorker</span><span class="p">(</span><span class="n">hamiltonian_func</span><span class="p">,</span> <span class="n">k_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">do_work</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_grid_results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span> <span class="o">=</span> <span class="n">ProgressDialog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">progress_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">update_progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_aborted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">cancel_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">request_abort</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DirectConnection</span>
        <span class="p">)</span>

        <span class="c1"># Cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">task_aborted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># Only show the dialog after a delay if it&#39;s still running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">maybe_show_dialog</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">maybe_show_dialog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>  <span class="c1"># Delay in ms</span>

        <span class="c1"># Wait for the thread to finish and kill the timer if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_grid_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the results of the BZ grid calculation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res : tuple[list[NDArray[np.float64]], \</span>
<span class="sd">            list[NDArray[np.float64]], list[NDArray[np.float64]]]</span>
<span class="sd">            Contains the eigenvalues, eigenvectors, and k-points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;BZ grid calculation completed.&quot;</span><span class="p">)</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

        <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">k_points</span> <span class="o">=</span> <span class="n">res</span>

        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">k_points</span> <span class="o">=</span> <span class="n">k_points</span>
        <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">is_gamma_centered</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">grid_choice_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Update combo to make sure all sites are selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_combo</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_bands_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the `BandsPanel`.</span>

<span class="sd">        The UI components are activated/deactivated based on</span>
<span class="sd">        the system parameters.</span>
<span class="sd">        Projection menu is also updated programmatically.</span>
<span class="sd">        Selection is set to &quot;bands&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the radio toggle to bands</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">bands_radio</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>
            <span class="c1"># Get the system dimensionality</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">is_periodic</span>
                <span class="o">+</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">is_periodic</span>
                <span class="o">+</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">is_periodic</span>
            <span class="p">)</span>
            <span class="c1"># Fill out the fields</span>
            <span class="n">bandstructure</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span>
            <span class="n">bz_grid</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span>

            <span class="k">if</span> <span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="c1"># Set the type of the grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">grid_choice_group</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
                <span class="n">bz_grid</span><span class="o">.</span><span class="n">is_gamma_centered</span>
            <span class="p">)</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># BZ path selection buttons</span>
        <span class="c1"># Activate/deactivate buttons based on dimensionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">add_gamma_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">vertex_btns</span><span class="p">:</span>
            <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">edge_btns</span><span class="p">:</span>
            <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">face_btns</span><span class="p">:</span>
            <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Computation and BZ path buttons</span>
        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">remove_last_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_path_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_bands_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">remove_last_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_path_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_bands_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="c1"># BZ grid spinboxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># BZ grid spinboxes and button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_grid_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Update the projection combo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_combo</span><span class="p">()</span>

        <span class="c1"># Update the approximate output size labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_band_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_BZ_output</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the states in the combo box.</span>

<span class="sd">        Once the items are updated, the selection buttons are activated</span>
<span class="sd">        if the number of items is not zero. Additionally, all the items</span>
<span class="sd">        are selected programatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">state_info</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">get_states</span><span class="p">()</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state_info</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">refresh_combo</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">select_all_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_all_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">select_all</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_projection_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the indices of the selected states from the projection menu.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[int]</span>
<span class="sd">            Indices of the selected states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">checked_items</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dos_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the DOS properties for the plots.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[int, int, np.float64]</span>
<span class="sd">            Number of bins/points to be used in the plot, the plot type</span>
<span class="sd">            (0 for a histogram, 1 for Lorentzian), and Lorentzian broadening</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">num_bins_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">plot_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">presentation_choice_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span>
        <span class="n">broadening</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">broadening_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.bands_controller.BandsController.get_dos_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dos_properties</span><span class="p">()</span></code>

<a href="#TiBi.controllers.bands_controller.BandsController.get_dos_properties" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the DOS properties for the plots.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="numpy.float64">float64</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins/points to be used in the plot, the plot type
(0 for a histogram, 1 for Lorentzian), and Lorentzian broadening</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/bands_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dos_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the DOS properties for the plots.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[int, int, np.float64]</span>
<span class="sd">        Number of bins/points to be used in the plot, the plot type</span>
<span class="sd">        (0 for a histogram, 1 for Lorentzian), and Lorentzian broadening</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">num_bins_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="n">plot_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">presentation_choice_group</span><span class="o">.</span><span class="n">checkedId</span><span class="p">()</span>
    <span class="n">broadening</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">broadening_spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.bands_controller.BandsController.get_projection_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_projection_indices</span><span class="p">()</span></code>

<a href="#TiBi.controllers.bands_controller.BandsController.get_projection_indices" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the indices of the selected states from the projection menu.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of the selected states</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/bands_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_projection_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the indices of the selected states from the projection menu.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[int]</span>
<span class="sd">        Indices of the selected states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">checked_items</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.bands_controller.BandsController.update_bands_panel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_bands_panel</span><span class="p">()</span></code>

<a href="#TiBi.controllers.bands_controller.BandsController.update_bands_panel" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update the <code>BandsPanel</code>.</p>
<p>The UI components are activated/deactivated based on
the system parameters.
Projection menu is also updated programmatically.
Selection is set to "bands"</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/bands_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_bands_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the `BandsPanel`.</span>

<span class="sd">    The UI components are activated/deactivated based on</span>
<span class="sd">    the system parameters.</span>
<span class="sd">    Projection menu is also updated programmatically.</span>
<span class="sd">    Selection is set to &quot;bands&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the radio toggle to bands</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
        <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">bands_radio</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">buttons</span><span class="p">():</span>
        <span class="n">b</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>
        <span class="c1"># Get the system dimensionality</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">is_periodic</span>
            <span class="o">+</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">is_periodic</span>
            <span class="o">+</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">is_periodic</span>
        <span class="p">)</span>
        <span class="c1"># Fill out the fields</span>
        <span class="n">bandstructure</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span>
        <span class="n">bz_grid</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">bz_grid</span>

        <span class="k">if</span> <span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">n_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Set the type of the grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">grid_choice_group</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
            <span class="n">bz_grid</span><span class="o">.</span><span class="n">is_gamma_centered</span>
        <span class="p">)</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">grid_divs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># BZ path selection buttons</span>
    <span class="c1"># Activate/deactivate buttons based on dimensionality</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">add_gamma_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">vertex_btns</span><span class="p">:</span>
        <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">edge_btns</span><span class="p">:</span>
        <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">face_btns</span><span class="p">:</span>
        <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Computation and BZ path buttons</span>
    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">remove_last_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_path_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_bands_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">remove_last_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_path_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_bands_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">)</span>

    <span class="c1"># BZ grid spinboxes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># BZ grid spinboxes and button</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v1_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v2_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">v3_points_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">compute_grid_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Update the projection combo</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_combo</span><span class="p">()</span>

    <span class="c1"># Update the approximate output size labels</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_band_output</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_approximate_BZ_output</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.bands_controller.BandsController.update_combo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_combo</span><span class="p">()</span></code>

<a href="#TiBi.controllers.bands_controller.BandsController.update_combo" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update the states in the combo box.</p>
<p>Once the items are updated, the selection buttons are activated
if the number of items is not zero. Additionally, all the items
are selected programatically.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/bands_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the states in the combo box.</span>

<span class="sd">    Once the items are updated, the selection buttons are activated</span>
<span class="sd">    if the number of items is not zero. Additionally, all the items</span>
<span class="sd">    are selected programatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">state_info</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">get_states</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state_info</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">refresh_combo</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">select_all_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_all_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">proj_combo</span><span class="o">.</span><span class="n">select_all</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.BrillouinZonePlotController" class="doc doc-heading">
            <code>TiBi.controllers.BrillouinZonePlotController</code>


<a href="#TiBi.controllers.BrillouinZonePlotController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller for the Brillouin zone plot view.</p>
<p>This controller manages the 3D visualization of the Brillouin zone.
It handles the visualization of selected high-symmetry points within
the BZ and paths for band structure calculations.</p>
<p>The controller observes two views: BZ plot itself and a panel in the
computation view which allows one to select BZ points and create
path.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.bz_plot_view">bz_plot_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.BrillouinZonePlotView (TiBi.views.bz_plot_view.BrillouinZonePlotView)" href="../views/#TiBi.views.BrillouinZonePlotView">BrillouinZonePlotView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The view component for displaying the Brillouin zone</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.computation_view">computation_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.ComputationView (TiBi.views.computation_view.ComputationView)" href="../views/#TiBi.views.ComputationView">ComputationView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The view component that contains controls for creating
a path in the BZ</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.undo_stack">undo_stack</span></code></td>
            <td>
                  <code><span title="PySide6.QtGui.QUndoStack">QUndoStack</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>QUndoStack</code> to hold "undo-able" commands</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.unit_cell">unit_cell</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The currently selected unit cell</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.bz_plot_items">bz_plot_items</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary to store plot items</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.dim">dim</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dimensionality of the Brillouin zone</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.bz_point_selection">bz_point_selection</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of the selected high-symmetry points in the BZ</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.bz_point_lists">bz_point_lists</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lists of high-symmetry points, grouped by type</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.BrillouinZonePlotController.bz_path_updated">bz_path_updated</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Emitted when the BZ special points path is updated
by adding or removing points. Triggers a redraw of
the path in the plot.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_brillouin_zone() (TiBi.controllers.BrillouinZonePlotController.update_brillouin_zone)" href="#TiBi.controllers.BrillouinZonePlotController.update_brillouin_zone">update_brillouin_zone</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Draw the Brillouin zone of the selected <code>UnitCell</code>.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/bz_plot_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BrillouinZonePlotController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for the Brillouin zone plot view.</span>

<span class="sd">    This controller manages the 3D visualization of the Brillouin zone.</span>
<span class="sd">    It handles the visualization of selected high-symmetry points within</span>
<span class="sd">    the BZ and paths for band structure calculations.</span>

<span class="sd">    The controller observes two views: BZ plot itself and a panel in the</span>
<span class="sd">    computation view which allows one to select BZ points and create</span>
<span class="sd">    path.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    bz_plot_view : BrillouinZonePlotView</span>
<span class="sd">        The view component for displaying the Brillouin zone</span>
<span class="sd">    computation_view : ComputationView</span>
<span class="sd">        The view component that contains controls for creating</span>
<span class="sd">        a path in the BZ</span>
<span class="sd">    undo_stack : QUndoStack</span>
<span class="sd">        `QUndoStack` to hold &quot;undo-able&quot; commands</span>
<span class="sd">    unit_cell : UnitCell</span>
<span class="sd">        The currently selected unit cell</span>
<span class="sd">    bz_plot_items : dict</span>
<span class="sd">        Dictionary to store plot items</span>
<span class="sd">    dim : int</span>
<span class="sd">        Dimensionality of the Brillouin zone</span>
<span class="sd">    bz_point_selection : dict</span>
<span class="sd">        Indices of the selected high-symmetry points in the BZ</span>
<span class="sd">    bz_point_lists : dict</span>
<span class="sd">        Lists of high-symmetry points, grouped by type</span>
<span class="sd">    bz_path_updated : Signal</span>
<span class="sd">        Emitted when the BZ special points path is updated</span>
<span class="sd">        by adding or removing points. Triggers a redraw of</span>
<span class="sd">        the path in the plot.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    update_brillouin_zone()</span>
<span class="sd">        Draw the Brillouin zone of the selected `UnitCell`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bz_path_updated</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">bz_plot_view</span><span class="p">:</span> <span class="n">BrillouinZonePlotView</span><span class="p">,</span>
        <span class="n">computation_view</span><span class="p">:</span> <span class="n">ComputationView</span><span class="p">,</span>
        <span class="n">undo_stack</span><span class="p">:</span> <span class="n">QUndoStack</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span> <span class="o">=</span> <span class="n">bz_plot_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span> <span class="o">=</span> <span class="n">computation_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span> <span class="o">=</span> <span class="n">undo_stack</span>

        <span class="c1"># Internal controller state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary to store plot items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Dimensionality</span>
        <span class="c1"># Indices of the selected high-symmetry points in the BZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span> <span class="o">=</span> <span class="n">bz_point_selection_init</span><span class="p">()</span>
        <span class="c1"># Lists of high-symmetry points, grouped by type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span> <span class="o">=</span> <span class="n">bz_point_lists_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bz_path_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_path_visualization</span><span class="p">)</span>

        <span class="c1"># Signals from the ComputationView used for selecting/picking</span>
        <span class="c1"># high-symmetry points in the BZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">add_gamma_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">prev_vertex_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_point</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">next_vertex_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_point</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">add_vertex_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="s2">&quot;vertex&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">prev_edge_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_point</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;edge&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">next_edge_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_point</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;edge&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">add_edge_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">prev_face_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_point</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;face&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">next_face_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_point</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;face&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">add_face_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="s2">&quot;face&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">remove_last_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_last_point</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span><span class="o">.</span><span class="n">clear_path_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_path</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_brillouin_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw the Brillouin zone of the selected `UnitCell`.</span>

<span class="sd">        This method is the core rendering function that:</span>
<span class="sd">        1. Clears any existing visualization</span>
<span class="sd">        2. Calculates the Brillouin zone vertices and faces</span>
<span class="sd">        3. Renders the BZ wireframe and key points (Gamma, vertices,</span>
<span class="sd">        edge midpoints, face centers)</span>
<span class="sd">        4. Updates UI controls based on the dimensionality of the BZ</span>

<span class="sd">        The method is triggered whenever the `UnitCell` changes or</span>
<span class="sd">        a new unit cell is selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="c1"># Clear previous plot items except axes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Indices of the selected high-symmetry points in the BZ</span>
        <span class="c1"># The key is the type of the high symmetry point</span>
        <span class="c1"># (&quot;face&quot;, &quot;edge&quot;, &quot;vertex&quot;)</span>
        <span class="c1"># The values are the cardinal indices of each type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span> <span class="o">=</span> <span class="n">bz_point_selection_init</span><span class="p">()</span>
        <span class="c1"># Lists of high-symmetry points, grouped by type.</span>
        <span class="c1"># The key is the type of the high symmetry point</span>
        <span class="c1"># (&quot;face&quot;, &quot;edge&quot;, &quot;vertex&quot;)</span>
        <span class="c1"># The values are arrays of length-3 arrays of coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span> <span class="o">=</span> <span class="n">bz_point_lists_init</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

        <span class="c1"># Guard against 0-volume Brillouin zone: can occur in the process</span>
        <span class="c1"># of creation of the unit cell or due to a mistake</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">get_BZ</span><span class="p">()</span>

        <span class="c1"># Determine system dimensionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Extract vertices and faces from the BZ data</span>
        <span class="c1"># Note: In 2D, the faces are equivalent to edges.</span>
        <span class="c1"># In 3D, the faces are polygons.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;vertex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Get the edge points</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span><span class="p">:</span>
                <span class="c1"># Midpoint of the edge</span>
                <span class="n">mid_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mid_point</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Use the set of unique edges to avoid duplication</span>
            <span class="c1"># due to faces sharing edges</span>
            <span class="n">unique_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">edge_midpoints</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)):</span>
                    <span class="n">next_ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="n">next_ii</span><span class="p">])</span>
                    <span class="n">edge</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_edges</span><span class="p">:</span>
                        <span class="n">unique_edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                        <span class="n">midpoint</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v2</span><span class="p">))</span>
                        <span class="n">edge_midpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>

                <span class="c1"># Face midpoint (no duplication issue here)</span>
                <span class="n">face_mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_mid</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edge_midpoints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">])</span>

        <span class="c1"># Draw the path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_path_visualization</span><span class="p">()</span>
        <span class="c1"># Create the BZ wireframe by making edges</span>
        <span class="c1"># (connect the vertices based on face data)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_bz_wireframe</span><span class="p">()</span>

        <span class="c1"># Plot the BZ points as spheres</span>
        <span class="c1"># Add Gamma point at origin</span>
        <span class="n">sphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_point</span><span class="p">()</span>
        <span class="n">sphere</span><span class="o">.</span><span class="n">setColor</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="s2">&quot;Gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere</span>

        <span class="c1"># Plot points for vertices, edges, and faces</span>
        <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Pad all the points of the same type</span>
                <span class="n">pt_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_to_3d</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                <span class="c1"># Select the 1st point of the type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Loop over all the padded points</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pt_3d</span><span class="p">):</span>
                    <span class="c1"># Make a sphere and position it</span>
                    <span class="c1"># at the appropriate location</span>
                    <span class="n">sphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_point</span><span class="p">()</span>
                    <span class="n">sphere</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;bz_</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere</span>
                    <span class="c1"># Highlight the first point</span>
                    <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sphere</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">selected_point_color</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_bz_wireframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a wireframe visualization of the Brillouin zone.</span>

<span class="sd">        This method extracts edges from the Brillouin zone faces and creates a</span>
<span class="sd">        GLLinePlotItem to visualize them.</span>

<span class="sd">        For 2D BZ, the wireframe is a polygon outline.</span>
<span class="sd">        For 3D BZ, the wireframe is the edges of the polyhedron.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">unique_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)):</span>
                    <span class="n">next_ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="n">next_ii</span><span class="p">])</span>
                    <span class="n">edge</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
                    <span class="n">unique_edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

            <span class="c1"># Convert edges to line vertices</span>
            <span class="n">line_vertices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">unique_edges</span><span class="p">:</span>
                <span class="n">line_vertices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">])</span>

            <span class="c1"># Make sure all the line vertices are 3D</span>
            <span class="n">line_vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_to_3d</span><span class="p">(</span><span class="n">line_vertices</span><span class="p">)</span>

            <span class="c1"># Create a GLLinePlotItem for all BZ edges</span>
            <span class="n">bz_wireframe</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line_vertices</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">bz_wireframe</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="s2">&quot;bz_wireframe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bz_wireframe</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertex_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a sphere mesh item for a point in the BZ.&quot;&quot;&quot;</span>
        <span class="c1"># vertex_size = 1 / (self.unit_cell.volume()) ** (1 / 3) / 4</span>
        <span class="k">return</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLMeshItem</span><span class="p">(</span>
            <span class="n">meshdata</span><span class="o">=</span><span class="n">gl</span><span class="o">.</span><span class="n">MeshData</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">vertex_size</span><span class="p">),</span>
            <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">point_color</span><span class="p">,</span>
            <span class="n">shader</span><span class="o">=</span><span class="s2">&quot;shaded&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pad_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure points have 3D coordinates by padding with zeros if needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points</span>
<span class="sd">            Array of point coordinates</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray</span>
<span class="sd">            Array of points with 3D coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>
        <span class="k">if</span> <span class="n">pad_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a point in the Brillouin zone based on type and</span>
<span class="sd">        step direction.</span>

<span class="sd">        This method implements the navigation through different types</span>
<span class="sd">        of points in the BZ (vertices, edge midpoints, or face centers).</span>
<span class="sd">        It updates the visual highlighting to show which point is currently</span>
<span class="sd">        selected, and maintains the selection state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step : int</span>
<span class="sd">            Direction to move in the selection</span>
<span class="sd">            (+1 for next, -1 for previous)</span>
<span class="sd">        typ : str</span>
<span class="sd">            Type of point to select (&#39;vertex&#39;, &#39;edge&#39;, or &#39;face&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Guard against empty vertex list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="n">typ</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">prev_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>
        <span class="c1"># Update the selection index</span>
        <span class="k">if</span> <span class="n">prev_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_point</span> <span class="o">+</span> <span class="n">step</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">prev_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bz_</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prev_point</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="n">prev_key</span><span class="p">]</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">point_color</span>
            <span class="p">)</span>

        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bz_</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">selected_point_color</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a selected point to the Brillouin zone path.</span>

<span class="sd">        This method adds the currently selected point (of the specified type)</span>
<span class="sd">        to the Brillouin zone path. The path is a sequence of k-points</span>
<span class="sd">        that will be used for band structure calculations.</span>
<span class="sd">        Points can be the origin (Gamma), vertices, edge midpoints, or</span>
<span class="sd">        face centers depending on the dimensionality of the BZ.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        point : str</span>
<span class="sd">            The type of point to add (&quot;gamma&quot;, &quot;vertex&quot;, &quot;edge&quot;, or &quot;face&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">point</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">point_coord</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">point_coord</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="n">point</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">point</span><span class="p">]]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No point selected&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="n">AddBZPointCommand</span><span class="p">(</span>
                <span class="n">unit_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">,</span>
                <span class="n">point</span><span class="o">=</span><span class="n">point_coord</span><span class="p">,</span>
                <span class="n">computation_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_path_updated</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_last_point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the last point added to the path.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="n">RemoveBZPointCommand</span><span class="p">(</span>
                <span class="n">unit_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">,</span>
                <span class="n">computation_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_path_updated</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clear_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all points from the path.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="n">ClearBZPathCommand</span><span class="p">(</span>
                <span class="n">unit_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">,</span>
                <span class="n">computation_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_path_updated</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_path_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the visualization of the BZ path based on current path points.</span>

<span class="sd">        This method creates or updates the visual representation of the k-path</span>
<span class="sd">        in the Brillouin zone. The path is shown as a series of connected</span>
<span class="sd">        line segments between the selected k-points.</span>
<span class="sd">        The visualization helps users understand the path along which</span>
<span class="sd">        the band structure will be calculated.</span>

<span class="sd">        If the path has fewer than 2 points, no visualization is created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove existing path visualization if it exists</span>
        <span class="k">if</span> <span class="s2">&quot;bz_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="s2">&quot;bz_path&quot;</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="s2">&quot;bz_path&quot;</span><span class="p">]</span>
        <span class="c1"># Only create visualization if we have at least 2 points</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Convert path points to 3D if needed</span>
        <span class="n">path_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span><span class="p">)</span>
        <span class="c1"># Create line segments for the path</span>
        <span class="n">path_pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path_3d</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Add both points of each segment</span>
            <span class="n">path_pos</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">path_3d</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">path_3d</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="c1"># Create the path visualization</span>
        <span class="n">path_object</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">path_pos</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">CF_RED</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">path_object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="s2">&quot;bz_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_object</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.BrillouinZonePlotController.update_brillouin_zone" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_brillouin_zone</span><span class="p">()</span></code>

<a href="#TiBi.controllers.BrillouinZonePlotController.update_brillouin_zone" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Draw the Brillouin zone of the selected <code>UnitCell</code>.</p>
<p>This method is the core rendering function that:
1. Clears any existing visualization
2. Calculates the Brillouin zone vertices and faces
3. Renders the BZ wireframe and key points (Gamma, vertices,
edge midpoints, face centers)
4. Updates UI controls based on the dimensionality of the BZ</p>
<p>The method is triggered whenever the <code>UnitCell</code> changes or
a new unit cell is selected.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/bz_plot_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_brillouin_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the Brillouin zone of the selected `UnitCell`.</span>

<span class="sd">    This method is the core rendering function that:</span>
<span class="sd">    1. Clears any existing visualization</span>
<span class="sd">    2. Calculates the Brillouin zone vertices and faces</span>
<span class="sd">    3. Renders the BZ wireframe and key points (Gamma, vertices,</span>
<span class="sd">    edge midpoints, face centers)</span>
<span class="sd">    4. Updates UI controls based on the dimensionality of the BZ</span>

<span class="sd">    The method is triggered whenever the `UnitCell` changes or</span>
<span class="sd">    a new unit cell is selected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
    <span class="c1"># Clear previous plot items except axes</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Indices of the selected high-symmetry points in the BZ</span>
    <span class="c1"># The key is the type of the high symmetry point</span>
    <span class="c1"># (&quot;face&quot;, &quot;edge&quot;, &quot;vertex&quot;)</span>
    <span class="c1"># The values are the cardinal indices of each type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span> <span class="o">=</span> <span class="n">bz_point_selection_init</span><span class="p">()</span>
    <span class="c1"># Lists of high-symmetry points, grouped by type.</span>
    <span class="c1"># The key is the type of the high symmetry point</span>
    <span class="c1"># (&quot;face&quot;, &quot;edge&quot;, &quot;vertex&quot;)</span>
    <span class="c1"># The values are arrays of length-3 arrays of coordinates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span> <span class="o">=</span> <span class="n">bz_point_lists_init</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

    <span class="c1"># Guard against 0-volume Brillouin zone: can occur in the process</span>
    <span class="c1"># of creation of the unit cell or due to a mistake</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">get_BZ</span><span class="p">()</span>

    <span class="c1"># Determine system dimensionality</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Extract vertices and faces from the BZ data</span>
    <span class="c1"># Note: In 2D, the faces are equivalent to edges.</span>
    <span class="c1"># In 3D, the faces are polygons.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;vertex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_vertices</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Get the edge points</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span><span class="p">:</span>
            <span class="c1"># Midpoint of the edge</span>
            <span class="n">mid_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mid_point</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Use the set of unique edges to avoid duplication</span>
        <span class="c1"># due to faces sharing edges</span>
        <span class="n">unique_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">edge_midpoints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_faces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)):</span>
                <span class="n">next_ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="n">next_ii</span><span class="p">])</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_edges</span><span class="p">:</span>
                    <span class="n">unique_edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                    <span class="n">midpoint</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v2</span><span class="p">))</span>
                    <span class="n">edge_midpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>

            <span class="c1"># Face midpoint (no duplication issue here)</span>
            <span class="n">face_mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_mid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;edge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edge_midpoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">])</span>

    <span class="c1"># Draw the path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_path_visualization</span><span class="p">()</span>
    <span class="c1"># Create the BZ wireframe by making edges</span>
    <span class="c1"># (connect the vertices based on face data)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create_bz_wireframe</span><span class="p">()</span>

    <span class="c1"># Plot the BZ points as spheres</span>
    <span class="c1"># Add Gamma point at origin</span>
    <span class="n">sphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_point</span><span class="p">()</span>
    <span class="n">sphere</span><span class="o">.</span><span class="n">setColor</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="s2">&quot;Gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere</span>

    <span class="c1"># Plot points for vertices, edges, and faces</span>
    <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_lists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Pad all the points of the same type</span>
            <span class="n">pt_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_to_3d</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
            <span class="c1"># Select the 1st point of the type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bz_point_selection</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Loop over all the padded points</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pt_3d</span><span class="p">):</span>
                <span class="c1"># Make a sphere and position it</span>
                <span class="c1"># at the appropriate location</span>
                <span class="n">sphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_point</span><span class="p">()</span>
                <span class="n">sphere</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_items</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;bz_</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere</span>
                <span class="c1"># Highlight the first point</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sphere</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bz_plot_view</span><span class="o">.</span><span class="n">selected_point_color</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.ComputationController" class="doc doc-heading">
            <code>TiBi.controllers.ComputationController</code>


<a href="#TiBi.controllers.ComputationController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller responsible for physics calculations within the application.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.computation_view">computation_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.ComputationView (TiBi.views.computation_view.ComputationView)" href="../views/#TiBi.views.ComputationView">ComputationView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>UI object containing the computation view</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.hopping_controller">hopping_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.hopping_controller.HoppingController" href="#TiBi.controllers.hopping_controller.HoppingController">HoppingController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Child controller in charge of the hopping panel of the computation UI</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.bands_controller">bands_controller</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.controllers.bands_controller.BandsController" href="#TiBi.controllers.bands_controller.BandsController">BandsController</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Child controller in charge of the bands panel of the computation UI</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.status_updated">status_updated</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span>(<span title="str">str</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Signal emitted to update the status of the computation</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.bands_plot_requested">bands_plot_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request bands plot.
Re-emitting signal from <code>BandsController</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.dos_plot_requested">dos_plot_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request DOS plot.
Re-emitting signal from <code>BandsController</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.hopping_segments_requested">hopping_segments_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Signal requesting the plotting of hopping segments in the
unit cell plot. Re-emitting signal for the <code>HoppingController</code>
when the user selects a pair of sites from the hopping matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.ComputationController.selection_requested">selection_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span>(<span title="object">object</span>, <span title="object">object</span>, <span title="object">object</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Signal requesting a programmatic selection. Re-emitting signal for
the <code>HoppingController</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_dos_properties() (TiBi.controllers.ComputationController.get_dos_properties)" href="#TiBi.controllers.ComputationController.get_dos_properties">get_dos_properties</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the number of bins/points, plot type, and broadening.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_pair_selection() (TiBi.controllers.ComputationController.get_pair_selection)" href="#TiBi.controllers.ComputationController.get_pair_selection">get_pair_selection</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the selected state pair from the hopping matrix, if any.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_projection_indices() (TiBi.controllers.ComputationController.get_projection_indices)" href="#TiBi.controllers.ComputationController.get_projection_indices">get_projection_indices</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the projection indices from the projection combo.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_bands_panel() (TiBi.controllers.ComputationController.update_bands_panel)" href="#TiBi.controllers.ComputationController.update_bands_panel">update_bands_panel</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Update the bands UI panel.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_hopping_panel() (TiBi.controllers.ComputationController.update_hopping_panel)" href="#TiBi.controllers.ComputationController.update_hopping_panel">update_hopping_panel</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Redraw the hoppings UI panel.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_projection_combo() (TiBi.controllers.ComputationController.update_projection_combo)" href="#TiBi.controllers.ComputationController.update_projection_combo">update_projection_combo</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Update the projection combo in the bands panel.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ComputationController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller responsible for physics calculations within the application.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    computation_view : ComputationView</span>
<span class="sd">        UI object containing the computation view</span>
<span class="sd">    hopping_controller : HoppingController</span>
<span class="sd">        Child controller in charge of the hopping panel of the computation UI</span>
<span class="sd">    bands_controller : BandsController</span>
<span class="sd">        Child controller in charge of the bands panel of the computation UI</span>
<span class="sd">    status_updated : Signal(str)</span>
<span class="sd">        Signal emitted to update the status of the computation</span>
<span class="sd">    bands_plot_requested : Signal</span>
<span class="sd">        Request bands plot.</span>
<span class="sd">        Re-emitting signal from `BandsController`</span>
<span class="sd">    dos_plot_requested : Signal</span>
<span class="sd">        Request DOS plot.</span>
<span class="sd">        Re-emitting signal from `BandsController`</span>
<span class="sd">    hopping_segments_requested : Signal</span>
<span class="sd">        Signal requesting the plotting of hopping segments in the</span>
<span class="sd">        unit cell plot. Re-emitting signal for the `HoppingController`</span>
<span class="sd">        when the user selects a pair of sites from the hopping matrix.</span>
<span class="sd">    selection_requested : Signal(object, object, object)</span>
<span class="sd">        Signal requesting a programmatic selection. Re-emitting signal for</span>
<span class="sd">        the `HoppingController`.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_dos_properties()</span>
<span class="sd">        Get the number of bins/points, plot type, and broadening.</span>
<span class="sd">    get_pair_selection()</span>
<span class="sd">        Get the selected state pair from the hopping matrix, if any.</span>
<span class="sd">    get_projection_indices()</span>
<span class="sd">        Get the projection indices from the projection combo.</span>
<span class="sd">    update_bands_panel()</span>
<span class="sd">        Update the bands UI panel.</span>
<span class="sd">    update_hopping_panel()</span>
<span class="sd">        Redraw the hoppings UI panel.</span>
<span class="sd">    update_projection_combo()</span>
<span class="sd">        Update the projection combo in the bands panel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status_updated</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="c1"># Hopping controller signals to relay</span>
    <span class="n">hopping_segments_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">selection_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="c1"># Band controller signals to relay</span>
    <span class="n">bands_plot_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">dos_plot_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">computation_view</span><span class="p">:</span> <span class="n">ComputationView</span><span class="p">,</span>
        <span class="n">undo_stack</span><span class="p">:</span> <span class="n">QUndoStack</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span> <span class="o">=</span> <span class="n">computation_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span> <span class="o">=</span> <span class="n">undo_stack</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="c1"># Component controllers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span> <span class="o">=</span> <span class="n">HoppingController</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">hopping_panel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span> <span class="o">=</span> <span class="n">BandsController</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">computation_view</span><span class="o">.</span><span class="n">bands_panel</span>
        <span class="p">)</span>
        <span class="c1"># Connect the signals</span>
        <span class="c1"># Hoppings Panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span><span class="o">.</span><span class="n">hopping_segments_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_segments_requested</span><span class="o">.</span><span class="n">emit</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span><span class="o">.</span><span class="n">selection_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selection_requested</span><span class="o">.</span><span class="n">emit</span>
        <span class="p">)</span>
        <span class="c1"># Bands Panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">bands_plot_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bands_plot_requested</span><span class="o">.</span><span class="n">emit</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dos_plot_requested</span><span class="o">.</span><span class="n">emit</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_updated</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pair_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the selected state pair from the hopping matrix, if any.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[tuple]  | list[None]</span>
<span class="sd">            List of selected states, if available, where the elements of</span>
<span class="sd">            the list are (site_name, site_id, state_name, state_id).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span><span class="o">.</span><span class="n">pair_selection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_hopping_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redraw the hoppings UI panel.</span>

<span class="sd">        This method is called when the user renames a tree item to make sure</span>
<span class="sd">        that the matrix table contains the correct item names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span><span class="o">.</span><span class="n">update_unit_cell</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_bands_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the bands UI panel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">update_bands_panel</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_projection_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the projection combo in the bands panel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">update_combo</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_projection_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the projection indices from the projection combo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">get_projection_indices</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dos_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of bins/points, plot type, and broadening.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[int, int]</span>
<span class="sd">            Number of bins/points to be used in the plot and the plot type</span>
<span class="sd">            (0 for a histogram, 1 for Lorentzian)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">get_dos_properties</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.ComputationController.get_dos_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dos_properties</span><span class="p">()</span></code>

<a href="#TiBi.controllers.ComputationController.get_dos_properties" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the number of bins/points, plot type, and broadening.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins/points to be used in the plot and the plot type
(0 for a histogram, 1 for Lorentzian)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dos_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the number of bins/points, plot type, and broadening.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[int, int]</span>
<span class="sd">        Number of bins/points to be used in the plot and the plot type</span>
<span class="sd">        (0 for a histogram, 1 for Lorentzian)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">get_dos_properties</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.ComputationController.get_pair_selection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pair_selection</span><span class="p">()</span></code>

<a href="#TiBi.controllers.ComputationController.get_pair_selection" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the selected state pair from the hopping matrix, if any.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="tuple">tuple</span>] | <span title="list">list</span>[None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of selected states, if available, where the elements of
the list are (site_name, site_id, state_name, state_id).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pair_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the selected state pair from the hopping matrix, if any.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[tuple]  | list[None]</span>
<span class="sd">        List of selected states, if available, where the elements of</span>
<span class="sd">        the list are (site_name, site_id, state_name, state_id).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span><span class="o">.</span><span class="n">pair_selection</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.ComputationController.get_projection_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_projection_indices</span><span class="p">()</span></code>

<a href="#TiBi.controllers.ComputationController.get_projection_indices" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the projection indices from the projection combo.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_projection_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the projection indices from the projection combo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">get_projection_indices</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.ComputationController.update_bands_panel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_bands_panel</span><span class="p">()</span></code>

<a href="#TiBi.controllers.ComputationController.update_bands_panel" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update the bands UI panel.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_bands_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the bands UI panel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">update_bands_panel</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.ComputationController.update_hopping_panel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_hopping_panel</span><span class="p">()</span></code>

<a href="#TiBi.controllers.ComputationController.update_hopping_panel" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Redraw the hoppings UI panel.</p>
<p>This method is called when the user renames a tree item to make sure
that the matrix table contains the correct item names.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_hopping_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redraw the hoppings UI panel.</span>

<span class="sd">    This method is called when the user renames a tree item to make sure</span>
<span class="sd">    that the matrix table contains the correct item names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hopping_controller</span><span class="o">.</span><span class="n">update_unit_cell</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.ComputationController.update_projection_combo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_projection_combo</span><span class="p">()</span></code>

<a href="#TiBi.controllers.ComputationController.update_projection_combo" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update the projection combo in the bands panel.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/computation_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_projection_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the projection combo in the bands panel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bands_controller</span><span class="o">.</span><span class="n">update_combo</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.hopping_controller.HoppingController" class="doc doc-heading">
            <code>TiBi.controllers.hopping_controller.HoppingController</code>


<a href="#TiBi.controllers.hopping_controller.HoppingController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller for the hopping parameter interface.</p>
<p>This controller manages the creation and editing of hopping parameters
(tight-binding matrix elements) between quantum states. It handles:</p>
<ol>
<li>The interactive matrix grid where each button represents a possible
   hopping between two states</li>
<li>The detailed parameter table for editing specific hopping values</li>
<li>The right-click context menu for performing operations like creating
   Hermitian partners</li>
</ol>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.hopping_view">hopping_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.panels.HoppingPanel" href="../views/#TiBi.views.panels.HoppingPanel">HoppingPanel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The main view component</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.undo_stack">undo_stack</span></code></td>
            <td>
                  <code><span title="PySide6.QtGui.QUndoStack">QUndoStack</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>QUndoStack</code> to hold "undo-able" commands</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.state_info">state_info</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="tuple">tuple</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tuples with state information         (site_name, site_id, state_name, state_id)        for each <code>State</code> in the <code>UnitCell</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.pair_selection">pair_selection</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="tuple">tuple</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>2-element list of tuples containing the selected state pair</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.hoppings">hoppings</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="tuple">tuple</span>[<span title="uuid">uuid</span>, <span title="uuid">uuid</span>], <span title="list">list</span>[<span title="tuple">tuple</span>[<span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>], <span title="numpy.complex128">complex128</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the hopping parameters for the <code>UnitCell</code>.
The keys are <code>State</code> UUID tuples. The values are lists of hoppings.
Each hopping is a tuple of a displacement tuple, given in
terms of lattice vectors, and a complex amplitude.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.btn_clicked">btn_clicked</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span>(<span title="object">object</span>, <span title="object">object</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Emitted when a hopping button is clicked. The Signal carries the source
and destination state info following the
(site_name, site_id, state_name, state_id) format.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.hoppings_changed">hoppings_changed</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span>(<span title="object">object</span>, <span title="object">object</span>, <span title="object">object</span>, <span title="object">object</span>, <span title="object">object</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Emitted by the command when couplings are modified.
The signal carries the information about the current item selection,
as well as the selection of the state pair. It triggers
a table and matrix update.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.hopping_segments_requested">hopping_segments_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Emitted when the coupling table is updated, triggering an
update of hopping segments.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.hopping_controller.HoppingController.selection_requested">selection_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span>(<span title="object">object</span>, <span title="object">object</span>, <span title="object">object</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Emitted when the selection change in the tree is required,
carrying the unit cell, site, and state IDs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_unit_cell() (TiBi.controllers.hopping_controller.HoppingController.update_unit_cell)" href="#TiBi.controllers.hopping_controller.HoppingController.update_unit_cell">update_unit_cell</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Update the hopping data model with the <code>UnitCell</code>'s hoppings</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/hopping_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HoppingController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for the hopping parameter interface.</span>

<span class="sd">    This controller manages the creation and editing of hopping parameters</span>
<span class="sd">    (tight-binding matrix elements) between quantum states. It handles:</span>

<span class="sd">    1. The interactive matrix grid where each button represents a possible</span>
<span class="sd">       hopping between two states</span>
<span class="sd">    2. The detailed parameter table for editing specific hopping values</span>
<span class="sd">    3. The right-click context menu for performing operations like creating</span>
<span class="sd">       Hermitian partners</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    hopping_view : HoppingPanel</span>
<span class="sd">        The main view component</span>
<span class="sd">    undo_stack : QUndoStack</span>
<span class="sd">        `QUndoStack` to hold &quot;undo-able&quot; commands</span>
<span class="sd">    state_info : list[tuple]</span>
<span class="sd">        List of tuples with state information \</span>
<span class="sd">        (site_name, site_id, state_name, state_id)\</span>
<span class="sd">        for each `State` in the `UnitCell`</span>
<span class="sd">    pair_selection : list[tuple]</span>
<span class="sd">        2-element list of tuples containing the selected state pair</span>
<span class="sd">    hoppings : dict[tuple[uuid, uuid],\</span>
<span class="sd">            list[tuple[tuple[int, int, int], np.complex128]]]</span>
<span class="sd">        Dictionary containing the hopping parameters for the `UnitCell`.</span>
<span class="sd">        The keys are `State` UUID tuples. The values are lists of hoppings.</span>
<span class="sd">        Each hopping is a tuple of a displacement tuple, given in</span>
<span class="sd">        terms of lattice vectors, and a complex amplitude.</span>
<span class="sd">    btn_clicked : Signal(object, object)</span>
<span class="sd">        Emitted when a hopping button is clicked. The Signal carries the source</span>
<span class="sd">        and destination state info following the</span>
<span class="sd">        (site_name, site_id, state_name, state_id) format.</span>
<span class="sd">    hoppings_changed : Signal(object, object, object, object, object)</span>
<span class="sd">        Emitted by the command when couplings are modified.</span>
<span class="sd">        The signal carries the information about the current item selection,</span>
<span class="sd">        as well as the selection of the state pair. It triggers</span>
<span class="sd">        a table and matrix update.</span>
<span class="sd">    hopping_segments_requested : Signal</span>
<span class="sd">        Emitted when the coupling table is updated, triggering an</span>
<span class="sd">        update of hopping segments.</span>
<span class="sd">    selection_requested : Signal(object, object, object)</span>
<span class="sd">        Emitted when the selection change in the tree is required,</span>
<span class="sd">        carrying the unit cell, site, and state IDs.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    update_unit_cell()</span>
<span class="sd">        Update the hopping data model with the `UnitCell`&#39;s hoppings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">btn_clicked</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">hoppings_changed</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">hopping_segments_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">selection_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">hopping_view</span><span class="p">:</span> <span class="n">HoppingPanel</span><span class="p">,</span>
        <span class="n">undo_stack</span><span class="p">:</span> <span class="n">QUndoStack</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span> <span class="o">=</span> <span class="n">hopping_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span> <span class="o">=</span> <span class="n">undo_stack</span>

        <span class="c1"># Internal controller state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Connect Signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn_clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_pair_selection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">add_row_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_empty_row</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">remove_row_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_selected_coupling</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">save_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_couplings</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoppings_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_hoppings_changed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_unit_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the hopping data model with the selected `UnitCell`&#39;s hoppings.</span>

<span class="sd">        This method is called when the selection changes in the tree view.</span>
<span class="sd">        It retrieves the currently selected unit cell and its hoppings,</span>
<span class="sd">        refreshing the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="c1"># Deselect the previous states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_pair_selection</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If no unit cell selected, hide the panels and exit early</span>
        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">info_label</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">uc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

            <span class="c1"># Get the states and their &quot;info&quot; from inside the unit cell</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">new_info</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">get_states</span><span class="p">()</span>

            <span class="c1"># Use the states and the info to construct the hopping matrix grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">hoppings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span> <span class="o">=</span> <span class="n">new_info</span>
            <span class="c1"># If there are no states in the unit cell, hide the panels</span>
            <span class="k">if</span> <span class="n">new_info</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">info_label</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_matrix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redraw the hopping matrix.</span>

<span class="sd">        Button colors are updated based on whether hoppings</span>
<span class="sd">        exist between states.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clear existing widgets in grid layout</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">matrix_panel</span><span class="o">.</span><span class="n">grid_layout</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">matrix_panel</span><span class="o">.</span><span class="n">grid_layout</span><span class="o">.</span><span class="n">takeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">widget</span><span class="p">():</span>
                <span class="n">item</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>

        <span class="c1"># Configure grid layout to center the content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">matrix_panel</span><span class="o">.</span><span class="n">grid_layout</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>

        <span class="c1"># Create the button grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">)):</span>
                <span class="n">btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">set_button_size</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="s2">&quot;small&quot;</span><span class="p">)</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">setContextMenuPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CustomContextMenu</span><span class="p">)</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">customContextMenuRequested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">jj</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">btn</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_context_menu</span><span class="p">(</span>
                        <span class="n">b</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Get the states</span>
                <span class="n">state1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">state2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="c1"># Apply button styles</span>

                <span class="n">hop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">[]))</span>
                <span class="n">hop_herm</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">state2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state1</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">[]))</span>
                <span class="n">has_hopping</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">hop</span><span class="p">)</span>
                <span class="n">hop_neg_conj</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">((</span><span class="o">-</span><span class="n">d1</span><span class="p">,</span> <span class="o">-</span><span class="n">d2</span><span class="p">,</span> <span class="o">-</span><span class="n">d3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="p">((</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">hop</span>
                <span class="p">)</span>
                <span class="n">is_hermitian</span> <span class="o">=</span> <span class="n">hop_neg_conj</span> <span class="o">==</span> <span class="n">hop_herm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_button_style</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">has_hopping</span><span class="p">,</span> <span class="n">is_hermitian</span><span class="p">)</span>

                <span class="c1"># Set tips to show both states when hovering.</span>
                <span class="c1"># Show the state and site names.</span>
                <span class="c1"># From second quantization, the hopping goes FROM column INTO</span>
                <span class="c1"># row (columns multiply annihilation operators,</span>
                <span class="c1"># rows multiply creation)</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">state1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">setStatusTip</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">state2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">state1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Button click handler implementation:</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">checked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">jj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">btn_clicked</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">r</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>  <span class="c1"># Format (TO_state, FROM_state)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Add the button to the grid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">matrix_panel</span><span class="o">.</span><span class="n">grid_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span>
                    <span class="n">btn</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span>
                <span class="p">)</span>
                <span class="c1"># Save to the button dictionary</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buttons</span><span class="p">[(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">)]</span> <span class="o">=</span> <span class="n">btn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_button_style</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">:</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">has_hopping</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the appropriate style to a button based on its hoppings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        button : QPushButton</span>
<span class="sd">            The button to style</span>
<span class="sd">        has_hopping : bool</span>
<span class="sd">            Indicator whether the button marks a connection with hoppings</span>
<span class="sd">        hermitian : bool</span>
<span class="sd">            Boolean indicating whether the coupling is Hermitian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_hopping</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">BUTTON_STYLE_DEFAULT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hermitian</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">=</span> <span class="n">BUTTON_STYLE_HAS_HOPPING</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">=</span> <span class="n">BUTTON_STYLE_NONHERMITIAN</span>

        <span class="n">button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_pair_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pair selection and the table to display hopping terms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s1 : tuple[str, uuid.UUID, str, uuid.UUID] | None</span>
<span class="sd">            Information tuple for the destination `State` (row)</span>
<span class="sd">        s2 : tuple[str, uuid.UUID, str, uuid.UUID] | None</span>
<span class="sd">            Information tuple for the source `State` (column)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Store the UUIDs of the selected states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_info_label</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span>
            <span class="p">)</span>

            <span class="c1"># Update the table title to show the selected states</span>
            <span class="c1"># (source → destination)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">table_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">s2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">s1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_table</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the table and repopulate it with the latest hopping terms&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span>
            <span class="mi">0</span>
        <span class="p">)</span>  <span class="c1"># Clear existing data</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">amplitude</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]),</span> <span class="p">[]</span>
        <span class="p">):</span>
            <span class="n">row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>

            <span class="c1"># Use cell widgets instead of QTableWidgetItem</span>
            <span class="n">spinbox_d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spinbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">d1</span><span class="p">)</span>
            <span class="n">spinbox_d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spinbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">d2</span><span class="p">)</span>
            <span class="n">spinbox_d3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spinbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">d3</span><span class="p">)</span>
            <span class="n">re_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_doublespinbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">amplitude</span><span class="p">))</span>
            <span class="n">im_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_doublespinbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">amplitude</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
                <span class="n">row_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spinbox_d1</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
                <span class="n">row_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spinbox_d2</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
                <span class="n">row_index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">spinbox_d3</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
                <span class="n">row_index</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">re_box</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
                <span class="n">row_index</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">im_box</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_segments_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_spinbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=-</span><span class="mi">99</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auxiliary function to create a spinbox for hopping displacement&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setButtonSymbols</span><span class="p">(</span><span class="n">QSpinBox</span><span class="o">.</span><span class="n">NoButtons</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">box</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_doublespinbox</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=-</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auxiliary function to create a double spinbox for hopping amplitude</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">()</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setButtonSymbols</span><span class="p">(</span><span class="n">QDoubleSpinBox</span><span class="o">.</span><span class="n">NoButtons</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">box</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_empty_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new empty row to the table&quot;&quot;&quot;</span>
        <span class="n">row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>

        <span class="c1"># Pre-fill with default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
            <span class="n">row_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spinbox</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
            <span class="n">row_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spinbox</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
            <span class="n">row_index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spinbox</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
            <span class="n">row_index</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_doublespinbox</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span>
            <span class="n">row_index</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_doublespinbox</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_selected_coupling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove selected row(s) from the table&quot;&quot;&quot;</span>
        <span class="n">selected_rows</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Get the selection model from the table</span>
        <span class="n">selection_model</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Get the selected rows</span>
        <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">selection_model</span><span class="o">.</span><span class="n">selectedRows</span><span class="p">()</span>

        <span class="c1"># Extract the row numbers from the selected indexes</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">selected_indexes</span><span class="p">:</span>
            <span class="n">selected_rows</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">())</span>

        <span class="c1"># Remove the rows from the table in reverse order to avoid</span>
        <span class="c1"># shifting issues</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">selected_rows</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_couplings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract data from the hopping table and save it to the `UnitCell`.</span>

<span class="sd">        Read all rows from the table, converting cell values to the</span>
<span class="sd">        appropriate types:</span>
<span class="sd">        - First 3 columns (d₁,d₂,d₃) to integers (displacement vector)</span>
<span class="sd">        - Last 2 columns (Re(t), Im(t)) to floats (complex amplitude)</span>

<span class="sd">        If the same triplet (d₁,d₂,d₃) appears more than once,</span>
<span class="sd">        the amplitudes are summed. The data is then passed to the</span>
<span class="sd">        `SaveHoppingsCommand` to update the unit cell model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_couplings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Extract values from each row in the table</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">table_panel</span><span class="o">.</span><span class="n">hopping_table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span> <span class="n">n</span>
                <span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Create the complex amplitude</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">re</span> <span class="o">+</span> <span class="n">im</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>

            <span class="c1"># Create a tuple for the displacement vector (d₁, d₂, d₃)</span>
            <span class="n">triplet</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">)</span>
            <span class="c1"># If the triplet already exists, merge amplitudes by adding</span>
            <span class="c1"># the new amplitude</span>
            <span class="k">if</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="n">new_couplings</span><span class="p">:</span>
                <span class="n">new_couplings</span><span class="p">[</span><span class="n">triplet</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amplitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_couplings</span><span class="p">[</span><span class="n">triplet</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span>

        <span class="c1"># Convert the dictionary to the expected format of the list of tuples.</span>
        <span class="c1"># Remove any entries with non-finite or zero amplitudes</span>
        <span class="n">merged_couplings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">((</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">amplitude</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">amplitude</span> <span class="ow">in</span> <span class="n">new_couplings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">amplitude</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">amplitude</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Only update the model if the hoppings have changed</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">merged_couplings</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">]</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]),</span> <span class="p">[]</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># No changes detected, just refresh the table in case the user</span>
            <span class="c1"># rearranged the rows without actually changing the data or</span>
            <span class="c1"># added rows with zero amplitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_table</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Update the data model with the new couplings and emit the signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="n">SaveHoppingsCommand</span><span class="p">(</span>
                <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                <span class="n">pair_selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">,</span>
                <span class="n">new_hoppings</span><span class="o">=</span><span class="n">merged_couplings</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppings_changed</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a context menu for the button to manage hoppings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        button : QPushButton</span>
<span class="sd">            The button that was right-clicked</span>
<span class="sd">        ii : int</span>
<span class="sd">            Row index of the button in the matrix</span>
<span class="sd">        jj : int</span>
<span class="sd">            Column index of the button in the matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="c1"># Send hopping data to the transpose element</span>
        <span class="n">action_send_hoppings</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Set transpose element&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">action_send_hoppings</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hermitian_partner</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action_send_hoppings</span><span class="p">)</span>

        <span class="c1"># Get hopping data from the transpose element</span>
        <span class="n">action_get_hoppings</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Get transpose element&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">action_get_hoppings</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hermitian_partner</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action_get_hoppings</span><span class="p">)</span>

        <span class="c1"># Clear hoppings</span>
        <span class="n">action_clear_hoppings</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Clear hoppings&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">action_clear_hoppings</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_coupling</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action_clear_hoppings</span><span class="p">)</span>

        <span class="n">menu</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="n">button</span><span class="o">.</span><span class="n">mapToGlobal</span><span class="p">(</span><span class="n">QPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">button</span><span class="o">.</span><span class="n">height</span><span class="p">())))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_hermitian_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Hermitian partner for the selected hopping.</span>

<span class="sd">        The Hermitian partner is created by negating the displacement vector</span>
<span class="sd">        and taking the complex conjugate of the amplitude.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ii : int</span>
<span class="sd">            Index of the destination state in the matrix</span>
<span class="sd">        jj : int</span>
<span class="sd">            Index of the source state in the matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># Destination</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>  <span class="c1"># Source</span>
        <span class="n">hop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">s1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">[])</span>
        <span class="n">hop_herm</span> <span class="o">=</span> <span class="p">[((</span><span class="o">-</span><span class="n">d1</span><span class="p">,</span> <span class="o">-</span><span class="n">d2</span><span class="p">,</span> <span class="o">-</span><span class="n">d3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="p">((</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">hop</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span> <span class="o">=</span> <span class="p">[</span><span class="n">s2</span><span class="p">,</span> <span class="n">s1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="n">SaveHoppingsCommand</span><span class="p">(</span>
                <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                <span class="n">pair_selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">,</span>
                <span class="n">new_hoppings</span><span class="o">=</span><span class="n">hop_herm</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppings_changed</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_delete_coupling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the coupling between two states.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ii : int</span>
<span class="sd">            Index of the destination state in the matrix (row index)</span>
<span class="sd">        jj : int</span>
<span class="sd">            Index of the source state in the matrix (column index)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># Destination</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>  <span class="c1"># Source</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_pair_selection</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
            <span class="n">SaveHoppingsCommand</span><span class="p">(</span>
                <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                <span class="n">pair_selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_selection</span><span class="p">,</span>
                <span class="n">new_hoppings</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppings_changed</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_hoppings_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redraw the matrix and table when hoppings are modified.</span>

<span class="sd">        If the selection at the point of the hopping change is different</span>
<span class="sd">        from the current one, emit a signal to update the selection in</span>
<span class="sd">        the tree. Otherwise, refresh the matrix. Additionally, select</span>
<span class="sd">        the pair of states and update the table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        uc_id : uuid.UUID</span>
<span class="sd">            UUID of the unit cell</span>
<span class="sd">        site_id : uuid.UUID</span>
<span class="sd">            UUID of the site</span>
<span class="sd">        state_id : uuid.UUID</span>
<span class="sd">            UUID of the state</span>
<span class="sd">        s1 : tuple[str, uuid.UUID, str, uuid.UUID]</span>
<span class="sd">            Information tuple for the destination `State` (row)</span>
<span class="sd">        s2 : tuple[str, uuid.UUID, str, uuid.UUID]</span>
<span class="sd">            Information tuple for the source `State` (column)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the unit cell selection needs to change, matrix redrawing</span>
        <span class="c1"># will be handled by the app controller as all panels are updated</span>
        <span class="c1"># Otherwise, we need to refresh the matrix manually.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">==</span> <span class="n">uc_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_matrix</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">!=</span> <span class="n">uc_id</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">site</span> <span class="o">!=</span> <span class="n">site_id</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state_id</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selection_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">)</span>

        <span class="c1"># Update Pair Selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_pair_selection</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.hopping_controller.HoppingController.update_unit_cell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_unit_cell</span><span class="p">()</span></code>

<a href="#TiBi.controllers.hopping_controller.HoppingController.update_unit_cell" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update the hopping data model with the selected <code>UnitCell</code>'s hoppings.</p>
<p>This method is called when the selection changes in the tree view.
It retrieves the currently selected unit cell and its hoppings,
refreshing the matrix.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/hopping_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_unit_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the hopping data model with the selected `UnitCell`&#39;s hoppings.</span>

<span class="sd">    This method is called when the selection changes in the tree view.</span>
<span class="sd">    It retrieves the currently selected unit cell and its hoppings,</span>
<span class="sd">    refreshing the matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
    <span class="c1"># Deselect the previous states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_pair_selection</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># If no unit cell selected, hide the panels and exit early</span>
    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">info_label</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">uc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>

        <span class="c1"># Get the states and their &quot;info&quot; from inside the unit cell</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_info</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">get_states</span><span class="p">()</span>

        <span class="c1"># Use the states and the info to construct the hopping matrix grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoppings</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">hoppings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_info</span> <span class="o">=</span> <span class="n">new_info</span>
        <span class="c1"># If there are no states in the unit cell, hide the panels</span>
        <span class="k">if</span> <span class="n">new_info</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">info_label</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hopping_view</span><span class="o">.</span><span class="n">panel</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_matrix</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.MainUIController" class="doc doc-heading">
            <code>TiBi.controllers.MainUIController</code>


<a href="#TiBi.controllers.MainUIController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller for the main UI components (menu bar, toolbar, status bar).</p>
<p>This controller connects the UI elements to the application logic and
manages the action manager that provides shared actions to the menu
bar and toolbar.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.project_path">project_path</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file to which the dictionary containing the unit
cell objects is saved</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.main_window">main_window</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.MainWindow (TiBi.views.main_window.MainWindow)" href="../views/#TiBi.views.MainWindow">MainWindow</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Subclass of QMainWindow containing the application's main view</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.menu_bar_view">menu_bar_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.MenuBarView (TiBi.views.menu_bar_view.MenuBarView)" href="../views/#TiBi.views.MenuBarView">MenuBarView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Standard menu bar</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.toolbar_view">toolbar_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.MainToolbarView (TiBi.views.main_toolbar_view.MainToolbarView)" href="../views/#TiBi.views.MainToolbarView">MainToolbarView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Toolbar at the top of the application window</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.status_bar_view">status_bar_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.StatusBarView (TiBi.views.status_bar_view.StatusBarView)" href="../views/#TiBi.views.StatusBarView">StatusBarView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Status bar at the bottom of the application window</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.undo_stack">undo_stack</span></code></td>
            <td>
                  <code><span title="PySide6.QtGui.QUndoStack">QUndoStack</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stack for 'undo-able' actions</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.project_refresh_requested">project_refresh_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request to refresh the project view after loading or creating a new one</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.MainUIController.unit_cell_update_requested">unit_cell_update_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request to update the unit cell plot with new parameters</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_uc_plot_properties() (TiBi.controllers.MainUIController.get_uc_plot_properties)" href="#TiBi.controllers.MainUIController.get_uc_plot_properties">get_uc_plot_properties</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the unit cell visualization properties.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="set_spinbox_status(n1_enabled, n2_enabled, n3_enabled) (TiBi.controllers.MainUIController.set_spinbox_status)" href="#TiBi.controllers.MainUIController.set_spinbox_status">set_spinbox_status</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Activate/deactivate unit cell spinboxes.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_status(message) (TiBi.controllers.MainUIController.update_status)" href="#TiBi.controllers.MainUIController.update_status">update_status</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Display a message in the status bar.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/main_ui_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MainUIController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for the main UI components (menu bar, toolbar, status bar).</span>

<span class="sd">    This controller connects the UI elements to the application logic and</span>
<span class="sd">    manages the action manager that provides shared actions to the menu</span>
<span class="sd">    bar and toolbar.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    project_path : str | None</span>
<span class="sd">        The file to which the dictionary containing the unit</span>
<span class="sd">        cell objects is saved</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    main_window : MainWindow</span>
<span class="sd">        Subclass of QMainWindow containing the application&#39;s main view</span>
<span class="sd">    menu_bar_view : MenuBarView</span>
<span class="sd">        Standard menu bar</span>
<span class="sd">    toolbar_view : MainToolbarView</span>
<span class="sd">        Toolbar at the top of the application window</span>
<span class="sd">    status_bar_view : StatusBarView</span>
<span class="sd">        Status bar at the bottom of the application window</span>
<span class="sd">    undo_stack : QUndoStack</span>
<span class="sd">        Stack for &#39;undo-able&#39; actions</span>
<span class="sd">    project_refresh_requested : Signal</span>
<span class="sd">        Request to refresh the project view after loading or creating a new one</span>
<span class="sd">    unit_cell_update_requested : Signal</span>
<span class="sd">        Request to update the unit cell plot with new parameters</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_uc_plot_properties()</span>
<span class="sd">        Get the unit cell visualization properties.</span>
<span class="sd">    set_spinbox_status()</span>
<span class="sd">        Activate/deactivate unit cell spinboxes.</span>
<span class="sd">    update_status(message : str)</span>
<span class="sd">        Display a message in the status bar.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unit_cell_update_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="c1"># Requst an updated unit cell plot</span>
    <span class="c1"># Request a UI refresh after creating a new project</span>
    <span class="c1"># or loading an existing one</span>
    <span class="n">project_refresh_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">main_window</span><span class="p">:</span> <span class="n">MainWindow</span><span class="p">,</span>
        <span class="n">menu_bar_view</span><span class="p">:</span> <span class="n">MenuBarView</span><span class="p">,</span>
        <span class="n">toolbar_view</span><span class="p">:</span> <span class="n">MainToolbarView</span><span class="p">,</span>
        <span class="n">status_bar_view</span><span class="p">:</span> <span class="n">StatusBarView</span><span class="p">,</span>
        <span class="n">undo_stack</span><span class="p">:</span> <span class="n">QUndoStack</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">=</span> <span class="n">project_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">main_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_bar</span> <span class="o">=</span> <span class="n">menu_bar_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span> <span class="o">=</span> <span class="n">toolbar_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">status_bar_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span> <span class="o">=</span> <span class="n">undo_stack</span>

        <span class="c1"># Create the action manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_manager</span> <span class="o">=</span> <span class="n">ActionManager</span><span class="p">(</span>
            <span class="n">undo_stack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>

        <span class="c1"># Set up action handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_action_handlers</span><span class="p">()</span>

        <span class="c1"># Set actions to views</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_bar</span><span class="o">.</span><span class="n">set_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">set_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_manager</span><span class="p">)</span>

        <span class="c1"># Connect spinbox signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n1_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_update_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n2_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_update_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n3_spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_update_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_action_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect actions to their handler methods.&quot;&quot;&quot;</span>
        <span class="c1"># Create a dictionary mapping action names to handler methods</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># File actions</span>
            <span class="s2">&quot;new_project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_new_project</span><span class="p">,</span>
            <span class="s2">&quot;open_project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_open_project</span><span class="p">,</span>
            <span class="s2">&quot;import_project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_import_project</span><span class="p">,</span>
            <span class="s2">&quot;save_project&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_save_project</span><span class="p">,</span> <span class="n">use_existing_path</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">),</span>
            <span class="s2">&quot;save_project_as&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_save_project</span><span class="p">,</span> <span class="n">use_existing_path</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">),</span>
            <span class="c1"># Undo/Redo actions</span>
            <span class="s2">&quot;undo&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">undo</span><span class="p">,</span>
            <span class="s2">&quot;redo&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">redo</span><span class="p">,</span>
            <span class="c1"># Unit cell actions</span>
            <span class="s2">&quot;wireframe&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_wireframe_toggle</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Connect actions to handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_manager</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>

    <span class="c1"># Methods to get information about the current state</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_uc_plot_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the unit cell visualization properties.</span>

<span class="sd">        The function returns the number of unit cells to be plotted</span>
<span class="sd">        along each basis vector, as well as whether the wireframe</span>
<span class="sd">        is plotted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int, int, int, bool</span>
<span class="sd">            Numbers of unit cells along each of the three vectors and</span>
<span class="sd">            a boolean for the wireframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="k">if</span> <span class="n">spinbox</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">spinbox</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n1_spinbox</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n2_spinbox</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n3_spinbox</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">wireframe_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_manager</span><span class="o">.</span><span class="n">unit_cell_actions</span><span class="p">[</span>
            <span class="s2">&quot;wireframe&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">wireframe_enabled</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_spinbox_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n1_enabled</span><span class="p">,</span> <span class="n">n2_enabled</span><span class="p">,</span> <span class="n">n3_enabled</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Activate/deactivate the unit cell spinboxes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n1_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">n1_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n2_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">n2_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n3_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">n3_enabled</span><span class="p">)</span>

    <span class="c1"># Handler methods for actions</span>
    <span class="nd">@Slot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_new_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle request to create a new project.</span>

<span class="sd">        A new project clears the current project, so the user has to</span>
<span class="sd">        respond to a warning. If the user confirms the creation of the project,</span>
<span class="sd">        the unit_cells dictionary is cleared, the project_path is set to None,</span>
<span class="sd">        and a request is set to reset all the models to the pristine state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Creating new project...&quot;</span><span class="p">)</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
            <span class="s2">&quot;Start New Project?&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;⚠️  This will clear your current project.\n\n</span>
<span class="sd">            Are you sure you want to continue?&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">,</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_refresh_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="nd">@Slot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_open_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle request to open a project from a JSON file.</span>

<span class="sd">        Opening a project clears the current project.</span>
<span class="sd">        The JSON data from the loaded file is deserialized so that the</span>
<span class="sd">        unit_cell dictionary can be filled. The project path is updated</span>
<span class="sd">        and a request is sent out to reset all other models</span>
<span class="sd">        to the pristine state (nothing selected).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Opening project...&quot;</span><span class="p">)</span>

        <span class="c1"># Open a file dialog for selecting a JSON file</span>
        <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
            <span class="s2">&quot;Open Unit Cells JSON&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>  <span class="c1"># starting directory</span>
            <span class="s2">&quot;JSON Files (*.json);;All Files (*)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">unit_cells</span> <span class="o">=</span> <span class="n">deserialize_unit_cells</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">unit_cells</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">=</span> <span class="n">file_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_refresh_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
                    <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to open file:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Failed to open project.&quot;</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_import_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle request to import a project.</span>

<span class="sd">        Importing a project is similar to loading with the difference being</span>
<span class="sd">        that the imported unit cells are added to the current project</span>
<span class="sd">        rather than replacing them.</span>
<span class="sd">        To avoid UUID clashes (if one imports the same project twice),</span>
<span class="sd">        the newly-imported unit cells have their UUID&#39;s regenerated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Importing project...&quot;</span><span class="p">)</span>

        <span class="c1"># Open a file dialog for selecting a JSON file</span>
        <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
            <span class="s2">&quot;Open Unit Cells JSON&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>  <span class="c1"># starting directory</span>
            <span class="s2">&quot;JSON Files (*.json);;All Files (*)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">unit_cells</span> <span class="o">=</span> <span class="n">deserialize_unit_cells</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>

                <span class="c1"># Go over the imported unit cells and regenerate their UUID&#39;s</span>
                <span class="n">new_unit_cells</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">uc</span> <span class="ow">in</span> <span class="n">unit_cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">new_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                    <span class="n">uc</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_id</span>
                    <span class="n">new_unit_cells</span><span class="p">[</span><span class="n">new_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">uc</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_unit_cells</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_refresh_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
                    <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to open file:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Failed to open project.&quot;</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_save_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_existing_path</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle request to save the current project.</span>

<span class="sd">        Save the current project to a JSON file. If the project already has</span>
<span class="sd">        a path, depending on whether the user clicks on Save or Save As,</span>
<span class="sd">        the project is either saved to that path or the user chooses a</span>
<span class="sd">        new file name. If there is no path, Save acts as Save As.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Saving project...&quot;</span><span class="p">)</span>
        <span class="n">json_string</span> <span class="o">=</span> <span class="n">serialize_unit_cells</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_existing_path</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If there is no path, open a dialog for the user to pick it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="c1"># Open a save file dialog</span>
            <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
                <span class="s2">&quot;Save Unit Cells As JSON&quot;</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>  <span class="c1"># starting directory</span>
                <span class="s2">&quot;JSON Files (*.json)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">+=</span> <span class="s2">&quot;.json&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">=</span> <span class="n">file_path</span>

    <span class="nd">@Slot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_wireframe_toggle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle wireframe toggle.</span>

<span class="sd">        Request a redrawing of the unit cell plot with/without the wireframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Implementation will be added later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_update_requested</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="c1"># Methods to be called from other controllers</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a message in the status bar.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : str</span>
<span class="sd">            Message to display</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.MainUIController.get_uc_plot_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_uc_plot_properties</span><span class="p">()</span></code>

<a href="#TiBi.controllers.MainUIController.get_uc_plot_properties" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the unit cell visualization properties.</p>
<p>The function returns the number of unit cells to be plotted
along each basis vector, as well as whether the wireframe
is plotted.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>(<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>, <span title="bool">bool</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Numbers of unit cells along each of the three vectors and
a boolean for the wireframe.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/main_ui_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_uc_plot_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the unit cell visualization properties.</span>

<span class="sd">    The function returns the number of unit cells to be plotted</span>
<span class="sd">    along each basis vector, as well as whether the wireframe</span>
<span class="sd">    is plotted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int, int, int, bool</span>
<span class="sd">        Numbers of unit cells along each of the three vectors and</span>
<span class="sd">        a boolean for the wireframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="k">if</span> <span class="n">spinbox</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">spinbox</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n1_spinbox</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n2_spinbox</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n3_spinbox</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="n">wireframe_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_manager</span><span class="o">.</span><span class="n">unit_cell_actions</span><span class="p">[</span>
        <span class="s2">&quot;wireframe&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">wireframe_enabled</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.MainUIController.set_spinbox_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_spinbox_status</span><span class="p">(</span><span class="n">n1_enabled</span><span class="p">,</span> <span class="n">n2_enabled</span><span class="p">,</span> <span class="n">n3_enabled</span><span class="p">)</span></code>

<a href="#TiBi.controllers.MainUIController.set_spinbox_status" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Activate/deactivate the unit cell spinboxes</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/main_ui_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_spinbox_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n1_enabled</span><span class="p">,</span> <span class="n">n2_enabled</span><span class="p">,</span> <span class="n">n3_enabled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Activate/deactivate the unit cell spinboxes&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n1_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">n1_enabled</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n2_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">n2_enabled</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">n3_spinbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">n3_enabled</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.MainUIController.update_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_status</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></code>

<a href="#TiBi.controllers.MainUIController.update_status" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Display a message in the status bar.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>message</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message to display</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/main_ui_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a message in the status bar.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    message : str</span>
<span class="sd">        Message to display</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.PlotController" class="doc doc-heading">
            <code>TiBi.controllers.PlotController</code>


<a href="#TiBi.controllers.PlotController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller for the 2D plot view.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.PlotController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.PlotController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.PlotController.plot_view">plot_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.PlotView (TiBi.views.plot_view.PlotView)" href="../views/#TiBi.views.PlotView">PlotView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>2D plot for displaying computed results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="plot_band_structure(states) (TiBi.controllers.PlotController.plot_band_structure)" href="#TiBi.controllers.PlotController.plot_band_structure">plot_band_structure</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot the band structure for the selected unit cell.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="plot_dos(num_bins, states, plot_type, broadening) (TiBi.controllers.PlotController.plot_dos)" href="#TiBi.controllers.PlotController.plot_dos">plot_dos</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Plot the density of states for the selected unit cell.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/plot_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlotController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for the 2D plot view.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    plot_view : PlotView</span>
<span class="sd">        2D plot for displaying computed results.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    plot_band_structure(states: list[int])</span>
<span class="sd">        Plot the band structure for the selected unit cell.</span>
<span class="sd">    plot_dos(num_bins: int, states: list[int], plot_type: int,\</span>
<span class="sd">             broadening: np.float64)</span>
<span class="sd">        Plot the density of states for the selected unit cell.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">plot_view</span><span class="p">:</span> <span class="n">PlotView</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span> <span class="o">=</span> <span class="n">plot_view</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_band_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        states : list[int]</span>
<span class="sd">            List of integers denoting onto which states</span>
<span class="sd">            the bands need to be projected.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="k">if</span> <span class="n">uc_id</span><span class="p">:</span>
            <span class="n">bandstructure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span><span class="o">.</span><span class="n">bandstructure</span>
            <span class="c1"># Set labels and grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;k-vector&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
            <span class="c1"># Hide x-axis tick and keep the grid only for y-axis</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="c1"># Extract the band structure quantities</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span>
            <span class="p">)</span>  <span class="c1"># Array of momenta for which the bands were computed</span>
            <span class="n">special_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span>
            <span class="p">)</span>  <span class="c1"># High symmetry points used to construct the BZ path</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">bandstructure</span><span class="o">.</span><span class="n">eigenvalues</span>
            <span class="p">)</span>  <span class="c1"># Array of arrays of computed eigenvalues</span>
            <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">bandstructure</span><span class="o">.</span><span class="n">eigenvectors</span>
            <span class="p">)</span>  <span class="c1"># Array of 2D arrays of eigenvectors. Eigenvectors are columns</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Get the positions along the path reflecting the point spacing</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">step</span><span class="p">)))</span>

                <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Normalize the path length to 1</span>

                <span class="c1"># Repeat the same for special points</span>
                <span class="n">step_special_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">special_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">pos_special_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">step_special_points</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">pos_special_points</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pos_special_points</span> <span class="o">/</span> <span class="n">pos_special_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Compute projection magnitude squared for each k-point</span>
                <span class="n">projections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">states</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">band_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">sizes</span> <span class="o">=</span> <span class="n">DEFAULT_SCATTER_RADIUS</span> <span class="o">*</span> <span class="n">projections</span><span class="p">[:,</span> <span class="n">band_idx</span><span class="p">]</span>

                    <span class="c1"># Plot the bands as lines</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">pos</span><span class="p">,</span> <span class="n">bands</span><span class="p">[:,</span> <span class="n">band_idx</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">CF_SKY</span>
                    <span class="p">)</span>
                    <span class="c1"># Plot the bands as scatterplots</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                        <span class="n">pos</span><span class="p">,</span>
                        <span class="n">bands</span><span class="p">[:,</span> <span class="n">band_idx</span><span class="p">],</span>
                        <span class="n">s</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">CF_VERMILLION</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Plot vertical lines at special points</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pos_special_points</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span>
                    <span class="p">)</span>
            <span class="c1"># Draw the canvas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the density of states using the Brillouin zone grid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_bins : int</span>
<span class="sd">            Number of histogram bins</span>
<span class="sd">        states : list[int]</span>
<span class="sd">            List of integers denoting onto which states</span>
<span class="sd">            the bands need to be projected.</span>
<span class="sd">        plot_type : int</span>
<span class="sd">            Histogram (0) or Lorentzian (1)</span>
<span class="sd">        broadening : np.float64</span>
<span class="sd">            Broadening parameter for the Lorentzian DOS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>

        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">:</span>
            <span class="n">bz_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span><span class="o">.</span><span class="n">bz_grid</span>

            <span class="c1"># Set labels and grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;DOS&quot;</span><span class="p">)</span>

            <span class="c1"># Extract the relevant qantities</span>
            <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvectors</span>
            <span class="p">)</span>  <span class="c1"># Array of 2D arrays of eigenvectors. Eigenvectors are columns</span>
            <span class="c1"># Create a single array of energies</span>
            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">)</span>
            <span class="c1"># For each k-point and each eigenstate, keep only the selected</span>
            <span class="c1"># basis states. Sum over the squared amplitudes of the selected</span>
            <span class="c1"># basis states for each state</span>

            <span class="c1"># eigenvectors: shape (num_kpts, num_states, num_basis),</span>
            <span class="c1"># where num_states = num_basis</span>
            <span class="c1"># eigenvectors[:, states, :] selects the desired basis projections</span>
            <span class="n">projections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">states</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

            <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram_bin_edges</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>
            <span class="c1"># Histogram or Lorentzian:</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Histogram</span>
                <span class="c1"># Construct a histogram using the selected states&#39; probability</span>
                <span class="c1"># for each eigenvalue as the weight</span>
                <span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                    <span class="n">energies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">projections</span>
                <span class="p">)</span>
                <span class="c1"># Get the bind centers and normalize the histogram</span>
                <span class="n">bin_centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">dos</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">k_points</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                    <span class="n">bin_centers</span><span class="p">,</span>
                    <span class="n">dos</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">CF_SKY</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="n">CF_BLUE</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get pairwise differences between the energy grid</span>
                <span class="c1"># and the centers of the Lorentzians</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">lorentzians</span> <span class="o">=</span> <span class="p">(</span><span class="n">broadening</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">broadening</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">dos</span> <span class="o">=</span> <span class="n">projections</span> <span class="o">@</span> <span class="n">lorentzians</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">k_points</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">bin_edges</span><span class="p">,</span> <span class="n">dos</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">CF_SKY</span>
                <span class="p">)</span>

            <span class="c1"># Draw the canvas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.PlotController.plot_band_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_band_structure</span><span class="p">(</span><span class="n">states</span><span class="p">)</span></code>

<a href="#TiBi.controllers.PlotController.plot_band_structure" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Plot the band structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>states</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of integers denoting onto which states
the bands need to be projected.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/plot_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_band_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the band structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    states : list[int]</span>
<span class="sd">        List of integers denoting onto which states</span>
<span class="sd">        the bands need to be projected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
    <span class="k">if</span> <span class="n">uc_id</span><span class="p">:</span>
        <span class="n">bandstructure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span><span class="o">.</span><span class="n">bandstructure</span>
        <span class="c1"># Set labels and grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;k-vector&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
        <span class="c1"># Hide x-axis tick and keep the grid only for y-axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="c1"># Extract the band structure quantities</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">bandstructure</span><span class="o">.</span><span class="n">path</span>
        <span class="p">)</span>  <span class="c1"># Array of momenta for which the bands were computed</span>
        <span class="n">special_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">bandstructure</span><span class="o">.</span><span class="n">special_points</span>
        <span class="p">)</span>  <span class="c1"># High symmetry points used to construct the BZ path</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">bandstructure</span><span class="o">.</span><span class="n">eigenvalues</span>
        <span class="p">)</span>  <span class="c1"># Array of arrays of computed eigenvalues</span>
        <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">bandstructure</span><span class="o">.</span><span class="n">eigenvectors</span>
        <span class="p">)</span>  <span class="c1"># Array of 2D arrays of eigenvectors. Eigenvectors are columns</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Get the positions along the path reflecting the point spacing</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">step</span><span class="p">)))</span>

            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Normalize the path length to 1</span>

            <span class="c1"># Repeat the same for special points</span>
            <span class="n">step_special_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">special_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">pos_special_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">step_special_points</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">pos_special_points</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pos_special_points</span> <span class="o">/</span> <span class="n">pos_special_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Compute projection magnitude squared for each k-point</span>
            <span class="n">projections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">states</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">band_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="n">DEFAULT_SCATTER_RADIUS</span> <span class="o">*</span> <span class="n">projections</span><span class="p">[:,</span> <span class="n">band_idx</span><span class="p">]</span>

                <span class="c1"># Plot the bands as lines</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">pos</span><span class="p">,</span> <span class="n">bands</span><span class="p">[:,</span> <span class="n">band_idx</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">CF_SKY</span>
                <span class="p">)</span>
                <span class="c1"># Plot the bands as scatterplots</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">pos</span><span class="p">,</span>
                    <span class="n">bands</span><span class="p">[:,</span> <span class="n">band_idx</span><span class="p">],</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">CF_VERMILLION</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Plot vertical lines at special points</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pos_special_points</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span>
                <span class="p">)</span>
        <span class="c1"># Draw the canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.PlotController.plot_dos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_dos</span><span class="p">(</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span><span class="p">)</span></code>

<a href="#TiBi.controllers.PlotController.plot_dos" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Plot the density of states using the Brillouin zone grid.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_bins</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of histogram bins</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>states</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of integers denoting onto which states
the bands need to be projected.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>plot_type</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Histogram (0) or Lorentzian (1)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>broadening</code>
            </td>
            <td>
                  <code><span title="numpy.float64">float64</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Broadening parameter for the Lorentzian DOS</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/plot_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">broadening</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the density of states using the Brillouin zone grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_bins : int</span>
<span class="sd">        Number of histogram bins</span>
<span class="sd">    states : list[int]</span>
<span class="sd">        List of integers denoting onto which states</span>
<span class="sd">        the bands need to be projected.</span>
<span class="sd">    plot_type : int</span>
<span class="sd">        Histogram (0) or Lorentzian (1)</span>
<span class="sd">    broadening : np.float64</span>
<span class="sd">        Broadening parameter for the Lorentzian DOS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>

    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span><span class="o">.</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">:</span>
        <span class="n">bz_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span><span class="o">.</span><span class="n">bz_grid</span>

        <span class="c1"># Set labels and grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;DOS&quot;</span><span class="p">)</span>

        <span class="c1"># Extract the relevant qantities</span>
        <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvectors</span>
        <span class="p">)</span>  <span class="c1"># Array of 2D arrays of eigenvectors. Eigenvectors are columns</span>
        <span class="c1"># Create a single array of energies</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">)</span>
        <span class="c1"># For each k-point and each eigenstate, keep only the selected</span>
        <span class="c1"># basis states. Sum over the squared amplitudes of the selected</span>
        <span class="c1"># basis states for each state</span>

        <span class="c1"># eigenvectors: shape (num_kpts, num_states, num_basis),</span>
        <span class="c1"># where num_states = num_basis</span>
        <span class="c1"># eigenvectors[:, states, :] selects the desired basis projections</span>
        <span class="n">projections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">states</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram_bin_edges</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>
        <span class="c1"># Histogram or Lorentzian:</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Histogram</span>
            <span class="c1"># Construct a histogram using the selected states&#39; probability</span>
            <span class="c1"># for each eigenvalue as the weight</span>
            <span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">energies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">projections</span>
            <span class="p">)</span>
            <span class="c1"># Get the bind centers and normalize the histogram</span>
            <span class="n">bin_centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">dos</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">k_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">bin_centers</span><span class="p">,</span>
                <span class="n">dos</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">CF_SKY</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="n">CF_BLUE</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get pairwise differences between the energy grid</span>
            <span class="c1"># and the centers of the Lorentzians</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lorentzians</span> <span class="o">=</span> <span class="p">(</span><span class="n">broadening</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">broadening</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dos</span> <span class="o">=</span> <span class="n">projections</span> <span class="o">@</span> <span class="n">lorentzians</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">bz_grid</span><span class="o">.</span><span class="n">k_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">bin_edges</span><span class="p">,</span> <span class="n">dos</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">CF_SKY</span>
            <span class="p">)</span>

        <span class="c1"># Draw the canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_view</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.UnitCellController" class="doc doc-heading">
            <code>TiBi.controllers.UnitCellController</code>


<a href="#TiBi.controllers.UnitCellController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller managing the <code>UnitCell</code>, <code>Site</code>, and <code>State</code> creation panel.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.unit_cell_view">unit_cell_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.UnitCellView (TiBi.views.uc_view.UnitCellView)" href="../views/#TiBi.views.UnitCellView">UnitCellView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The main view component</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.undo_stack">undo_stack</span></code></td>
            <td>
                  <code><span title="PySide6.QtGui.QUndoStack">QUndoStack</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>QUndoStack</code> to hold "undo-able" commands</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.v1, v2, v3">v1, v2, v3</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="TiBi.views.widgets.EnterKeySpinBox" href="../views/#TiBi.views.widgets.EnterKeySpinBox">EnterKeySpinBox</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lists of spinboxes for basis vector components</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.R, c1, c2, c3">R, c1, c2, c3</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.widgets.EnterKeySpinBox" href="../views/#TiBi.views.widgets.EnterKeySpinBox">EnterKeySpinBox</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spinboxes for site properties</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.tree_view_panel">tree_view_panel</span></code></td>
            <td>
                  <code><span title="TreeViewPanel">TreeViewPanel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tree view panel component</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.tree_view">tree_view</span></code></td>
            <td>
                  <code><span title="SystemTree">SystemTree</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tree view component</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.tree_model">tree_model</span></code></td>
            <td>
                  <code><span title="QStandardItemModel">QStandardItemModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model backing the tree view</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.unit_cell_parameter_changed">unit_cell_parameter_changed</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Signal emitted when a unit cell parameter is changed.
This triggers a redraw of the panels orchestrated by
the app_controller. Whenever unit cell parameter changes,
the derived quantities (band structure, BZ grid, etc),
are discarded due to being stale. The clearing is handled
by the associated commands.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.site_parameter_changed">site_parameter_changed</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Signal emitted when a site parameter is changed.
This triggers a redraw only of the unit cell plot.
Changing site parameters does not invalidate the derived quantities
since the site parameters are purely cosmetic.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellController.hopping_projection_update_requested">hopping_projection_update_requested</span></code></td>
            <td>
                  <code><span title="PySide6.QtCore.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Signal emitted when a tree item is renamed or the structure of the
unit cell changes (adding/removing states), requiring
an update of the hopping matrix and the projection selection.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="refresh_tree() (TiBi.controllers.UnitCellController.refresh_tree)" href="#TiBi.controllers.UnitCellController.refresh_tree">refresh_tree</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Redraw the system tree using the current system state.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="select_item(uc_id, site_id, state_id) (TiBi.controllers.UnitCellController.select_item)" href="#TiBi.controllers.UnitCellController.select_item">select_item</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Select a tree item using the ID's.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/uc_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UnitCellController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller managing the `UnitCell`, `Site`, and `State` creation panel.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    unit_cell_view : UnitCellView</span>
<span class="sd">        The main view component</span>
<span class="sd">    undo_stack : QUndoStack</span>
<span class="sd">        `QUndoStack` to hold &quot;undo-able&quot; commands</span>
<span class="sd">    v1, v2, v3 : list[EnterKeySpinBox]</span>
<span class="sd">        Lists of spinboxes for basis vector components</span>
<span class="sd">    R, c1, c2, c3 : EnterKeySpinBox</span>
<span class="sd">        Spinboxes for site properties</span>
<span class="sd">    tree_view_panel : TreeViewPanel</span>
<span class="sd">        The tree view panel component</span>
<span class="sd">    tree_view : SystemTree</span>
<span class="sd">        The tree view component</span>
<span class="sd">    tree_model : QStandardItemModel</span>
<span class="sd">        The model backing the tree view</span>
<span class="sd">    unit_cell_parameter_changed : Signal</span>
<span class="sd">        Signal emitted when a unit cell parameter is changed.</span>
<span class="sd">        This triggers a redraw of the panels orchestrated by</span>
<span class="sd">        the app_controller. Whenever unit cell parameter changes,</span>
<span class="sd">        the derived quantities (band structure, BZ grid, etc),</span>
<span class="sd">        are discarded due to being stale. The clearing is handled</span>
<span class="sd">        by the associated commands.</span>
<span class="sd">    site_parameter_changed : Signal</span>
<span class="sd">        Signal emitted when a site parameter is changed.</span>
<span class="sd">        This triggers a redraw only of the unit cell plot.</span>
<span class="sd">        Changing site parameters does not invalidate the derived quantities</span>
<span class="sd">        since the site parameters are purely cosmetic.</span>
<span class="sd">    hopping_projection_update_requested : Signal</span>
<span class="sd">        Signal emitted when a tree item is renamed or the structure of the</span>
<span class="sd">        unit cell changes (adding/removing states), requiring</span>
<span class="sd">        an update of the hopping matrix and the projection selection.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    refresh_tree()</span>
<span class="sd">        Redraw the system tree using the current system state.</span>
<span class="sd">    select_item(uc_id: uuid.UUID, site_id: uuid.UUID, state_id: uuid.UUID):</span>
<span class="sd">        Select a tree item using the ID&#39;s.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unit_cell_parameter_changed</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">site_parameter_changed</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">hopping_projection_update_requested</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">unit_cell_view</span><span class="p">:</span> <span class="n">UnitCellView</span><span class="p">,</span>
        <span class="n">undo_stack</span><span class="p">:</span> <span class="n">QUndoStack</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span> <span class="o">=</span> <span class="n">unit_cell_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span> <span class="o">=</span> <span class="n">undo_stack</span>

        <span class="c1"># Get the fields from unit_cell_view for convenience</span>
        <span class="c1"># For the basis vectors, each reference has three spinboxes</span>
        <span class="c1"># corresponding to the Cartesian coordinates</span>
        <span class="c1"># Unit Cell fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v3</span>

        <span class="c1"># Site fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span><span class="o">.</span><span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span><span class="o">.</span><span class="n">c1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span><span class="o">.</span><span class="n">c2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span><span class="o">.</span><span class="n">c3</span>

        <span class="c1"># Store the tree_view_panel, tree_view and tree_model as</span>
        <span class="c1"># attributes for convenience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">tree_view_panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span><span class="o">.</span><span class="n">tree_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">tree_model</span>

        <span class="c1"># Rebuild the tree view from scratch in the beginning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">refresh_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">)</span>

        <span class="c1"># SIGNALS</span>
        <span class="c1"># Selection change.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">selection_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_panels</span><span class="p">)</span>

        <span class="c1"># Tree view signals</span>
        <span class="c1"># When the tree selection changes, the selection model is updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">tree_selection_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">set_selection</span><span class="p">(</span>
                <span class="n">uc_id</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;unit_cell&quot;</span><span class="p">],</span> <span class="n">site_id</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">],</span> <span class="n">state_id</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Triggered when a tree item&#39;s name is changed by double clicking on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span><span class="o">.</span><span class="n">name_edit_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">RenameTreeItemCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">tree_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hopping_projection_update_requested</span><span class="p">,</span>
                    <span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span><span class="o">.</span><span class="n">itemFromIndex</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Triggered when the user presses Del or Backspace while</span>
        <span class="c1"># a tree item is highlighted, or clicks the Delete button</span>
        <span class="c1"># The signal is emitted only when there are states that are deleted</span>
        <span class="c1"># (either directly or as part of a site). If a state is deleted,</span>
        <span class="c1"># derived quantities (bands, BZ grid, etc.) are discarded</span>
        <span class="c1"># due to being stale.</span>
        <span class="c1"># If a unit cell is deleted,</span>
        <span class="c1"># the signal is not emitted as the unit cell deletion changes the</span>
        <span class="c1"># selection, which is handled separately.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span><span class="o">.</span><span class="n">delete_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">DeleteItemCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">tree_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hopping_projection_update_requested</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># New item creation using the tree delegate.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span><span class="o">.</span><span class="n">new_unit_cell_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">AddUnitCellCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span> <span class="n">tree_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span><span class="o">.</span><span class="n">new_site_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">AddSiteCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">tree_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view_panel</span><span class="o">.</span><span class="n">new_state_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">AddStateCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">tree_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hopping_projection_update_requested</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Unit Cell basis vector signals. Emitted when the user confirms</span>
        <span class="c1"># the change in the corresponding field but pressing Enter.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">connect_vector_fields</span><span class="p">(</span>
            <span class="n">vector_name</span><span class="p">,</span> <span class="n">spinboxes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EnterKeySpinBox</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">):</span>
                <span class="n">spinboxes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">editingConfirmed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">ii</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                        <span class="n">UpdateUnitCellParameterCommand</span><span class="p">(</span>
                            <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                            <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                            <span class="n">vector</span><span class="o">=</span><span class="n">vector_name</span><span class="p">,</span>
                            <span class="n">coordinate</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                            <span class="n">spinbox</span><span class="o">=</span><span class="n">spinboxes</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_parameter_changed</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Connect the fields for the three basis vectors</span>
        <span class="n">connect_vector_fields</span><span class="p">(</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v1</span><span class="p">)</span>
        <span class="n">connect_vector_fields</span><span class="p">(</span><span class="s2">&quot;v2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2</span><span class="p">)</span>
        <span class="n">connect_vector_fields</span><span class="p">(</span><span class="s2">&quot;v3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3</span><span class="p">)</span>

        <span class="c1"># Dimensionality radio buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radio_buttons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">radio0D</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">radio1D</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">radio2D</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">radio3D</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Dimensionality change signals from the radio buttons.</span>
        <span class="c1"># Changes in dimensionality trigger the same response</span>
        <span class="c1"># as in the basis vector coordinates.</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">radio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radio_buttons</span><span class="p">):</span>
            <span class="n">radio</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">checked</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dim</span><span class="p">:</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                        <span class="n">ChangeDimensionalityCommand</span><span class="p">(</span>
                            <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                            <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                            <span class="n">unit_cell_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="p">,</span>
                            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_parameter_changed</span><span class="p">,</span>
                            <span class="n">dim</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                            <span class="n">buttons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radio_buttons</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">checked</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Site panel signals.</span>
        <span class="c1"># Signals for fractional site coordinates.</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">]:</span>
            <span class="n">spinbox</span><span class="p">:</span> <span class="n">EnterKeySpinBox</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="n">spinbox</span><span class="o">.</span><span class="n">editingConfirmed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">spinbox</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                    <span class="n">UpdateSiteParameterCommand</span><span class="p">(</span>
                        <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                        <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                        <span class="n">param</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                        <span class="n">spinbox</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                        <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site_parameter_changed</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Site radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">editingConfirmed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">UpdateSiteParameterCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">param</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>
                    <span class="n">spinbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site_parameter_changed</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Button signals</span>
        <span class="c1"># Reduce button--LLL argorithm to obtain the primitive cell.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">reduce_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">ReduceBasisCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">unit_cell_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_parameter_changed</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Opens a color picker to change the color of the selected site</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span><span class="o">.</span><span class="n">color_picker_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pick_site_color</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_show_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the UI panels based on the current selection state.</span>

<span class="sd">        This method is called whenever the selection changes. It determines</span>
<span class="sd">        which panels should be visible and populates them with data from</span>
<span class="sd">        the selected items.</span>
<span class="sd">        The panels are shown or hidden using a stacked widget approach.</span>

<span class="sd">        The method handles all three levels of the hierarchy:</span>
<span class="sd">        - When a unit cell is selected, its properties are shown in</span>
<span class="sd">        the unit cell panel</span>
<span class="sd">        - When a site is selected, its properties are shown in the site panel</span>
<span class="sd">        - When a state is selected, no additional panel is shown as the state</span>
<span class="sd">        is only described by its name</span>

<span class="sd">        Buttons are also enabled/disabled based on the selection context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unit_cell_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="n">site_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">site</span>
        <span class="k">if</span> <span class="n">unit_cell_id</span><span class="p">:</span>
            <span class="c1"># Get the selected unit cell</span>
            <span class="n">uc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">unit_cell_id</span><span class="p">]</span>

            <span class="c1"># Get the system dimensionality</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">is_periodic</span> <span class="o">+</span> <span class="n">uc</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">is_periodic</span> <span class="o">+</span> <span class="n">uc</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">is_periodic</span>
            <span class="c1"># Set the dimensionality radio button.</span>
            <span class="c1"># Suppress the dim_listener since we are updating the radio</span>
            <span class="c1"># button programmatically</span>
            <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radio_buttons</span><span class="p">:</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">radio_group</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
                <span class="n">dim</span>
            <span class="p">)</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Enable the coordinate fields depending on the dimensionality</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">v3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radio_buttons</span><span class="p">:</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Set the basis vector fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span><span class="o">.</span><span class="n">set_basis_vectors</span><span class="p">(</span>
                <span class="n">uc</span><span class="o">.</span><span class="n">v1</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">v2</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">v3</span>
            <span class="p">)</span>

            <span class="c1"># Show the UnitCellPanel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">uc_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">unit_cell_panel</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">site_id</span><span class="p">:</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">site_id</span><span class="p">]</span>
                <span class="c1"># Set the fractional coordinates and radius fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c1</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c2</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c3</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">c3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>

                <span class="c1"># Set the color for the color picker button</span>
                <span class="n">site_color</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">color</span>

                <span class="n">c</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">site_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">site_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">site_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">site_color</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="p">)</span>  <span class="c1"># Color in 0-255 component range</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span><span class="o">.</span><span class="n">color_picker_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;background-color: rgba(</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">);&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Show the SitePanel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_panel</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no site is selected, hide the SitePanel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_info_label</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no unit cell is selected, hide the SitePanel and UnitCellPanel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">uc_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">uc_info_label</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_stack</span><span class="o">.</span><span class="n">setCurrentWidget</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="o">.</span><span class="n">site_info_label</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_site_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a color dialog to select a color for the selected site.</span>

<span class="sd">        After the color is picked, an undoable command is issued.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_color</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">site</span><span class="p">]</span>
            <span class="o">.</span><span class="n">color</span>
        <span class="p">)</span>

        <span class="c1"># Open the color dialog with the current color selected</span>
        <span class="n">start_color</span> <span class="o">=</span> <span class="n">QColor</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">old_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">old_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">old_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">old_color</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">new_color</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">start_color</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">QColorDialog</span><span class="o">.</span><span class="n">ShowAlphaChannel</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update the button color</span>
        <span class="k">if</span> <span class="n">new_color</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undo_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">ChangeSiteColorCommand</span><span class="p">(</span>
                    <span class="n">unit_cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">,</span>
                    <span class="n">selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">new_color</span><span class="o">=</span><span class="n">new_color</span><span class="p">,</span>
                    <span class="n">old_color</span><span class="o">=</span><span class="n">start_color</span><span class="p">,</span>
                    <span class="n">unit_cell_view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell_view</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site_parameter_changed</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redraw the system tree using the current system state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">refresh_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a tree item using the ID&#39;s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">_select_item_by_id</span><span class="p">(</span><span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.UnitCellController.refresh_tree" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">refresh_tree</span><span class="p">()</span></code>

<a href="#TiBi.controllers.UnitCellController.refresh_tree" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Redraw the system tree using the current system state.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/uc_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">refresh_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redraw the system tree using the current system state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">refresh_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.UnitCellController.select_item" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select_item</span><span class="p">(</span><span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">)</span></code>

<a href="#TiBi.controllers.UnitCellController.select_item" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Select a tree item using the ID's.</p>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/uc_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select a tree item using the ID&#39;s.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_view</span><span class="o">.</span><span class="n">_select_item_by_id</span><span class="p">(</span><span class="n">uc_id</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">state_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="TiBi.controllers.UnitCellPlotController" class="doc doc-heading">
            <code>TiBi.controllers.UnitCellPlotController</code>


<a href="#TiBi.controllers.UnitCellPlotController" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="PySide6.QtCore.QObject">QObject</span></code></p>


        <p>Controller for the unit cell 3D visualization.</p>
<p>This controller manages the 3D visualization of unit cells, handling the
rendering of unit cell wireframes, site positions, and periodic
repetitions.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellPlotController.unit_cells">unit_cells</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="uuid.UUID">UUID</span>, <a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping UUIDs to UnitCell objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellPlotController.selection">selection</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.Selection" href="../models/#TiBi.models.Selection">Selection</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model tracking the currently selected unit cell, site, and state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellPlotController.uc_plot_view">uc_plot_view</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.views.UnitCellPlotView (TiBi.views.uc_plot_view.UnitCellPlotView)" href="../views/#TiBi.views.UnitCellPlotView">UnitCellPlotView</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The view component for the 3D visualization</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellPlotController.unit_cell">unit_cell</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TiBi.models.UnitCell


  
      dataclass
  " href="../models/#TiBi.models.UnitCell">UnitCell</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unit cell currently being visualized</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="TiBi.controllers.UnitCellPlotController.uc_plot_items">uc_plot_items</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary to store plot items</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_hopping_segments(pair_selection) (TiBi.controllers.UnitCellPlotController.update_hopping_segments)" href="#TiBi.controllers.UnitCellPlotController.update_hopping_segments">update_hopping_segments</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Draw segments to indicate hopping connections.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="update_unit_cell(wireframe_shown, n1, n2, n3) (TiBi.controllers.UnitCellPlotController.update_unit_cell)" href="#TiBi.controllers.UnitCellPlotController.update_unit_cell">update_unit_cell</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Draw the selected <code>UnitCell</code> in the 3D view.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>TiBi/controllers/uc_plot_controller.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UnitCellPlotController</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for the unit cell 3D visualization.</span>

<span class="sd">    This controller manages the 3D visualization of unit cells, handling the</span>
<span class="sd">    rendering of unit cell wireframes, site positions, and periodic</span>
<span class="sd">    repetitions.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    unit_cells : dict[uuid.UUID, UnitCell]</span>
<span class="sd">        Dictionary mapping UUIDs to UnitCell objects</span>
<span class="sd">    selection : Selection</span>
<span class="sd">        Model tracking the currently selected unit cell, site, and state</span>
<span class="sd">    uc_plot_view : UnitCellPlotView</span>
<span class="sd">        The view component for the 3D visualization</span>
<span class="sd">    unit_cell : UnitCell</span>
<span class="sd">        The unit cell currently being visualized</span>
<span class="sd">    uc_plot_items : dict</span>
<span class="sd">        Dictionary to store plot items</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    update_hopping_segments(pair_selection: \</span>
<span class="sd">        tuple[tuple[str, uuid.UUID, str, uuid.UUID],\</span>
<span class="sd">            tuple[str, uuid.UUID, str, uuid.UUID]])</span>
<span class="sd">        Draw segments to indicate hopping connections.</span>
<span class="sd">    update_unit_cell(wireframe_shown: bool, n1: int, n2: int, n3: int)</span>
<span class="sd">        Draw the selected `UnitCell` in the 3D view.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UnitCell</span><span class="p">],</span>
        <span class="n">selection</span><span class="p">:</span> <span class="n">Selection</span><span class="p">,</span>
        <span class="n">uc_plot_view</span><span class="p">:</span> <span class="n">UnitCellPlotView</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span> <span class="o">=</span> <span class="n">unit_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span> <span class="o">=</span> <span class="n">uc_plot_view</span>

        <span class="c1"># Internal controller state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Unit cell being plotted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary to store plot items</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_unit_cell</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">wireframe_shown</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">n1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n3</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw the selected `UnitCell` in the 3D view.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wireframe_shown : bool</span>
<span class="sd">            Denotes whether the primitive vector wireframe is drawn</span>
<span class="sd">        n1, n2, n3 : int</span>
<span class="sd">            Number of repetitions along the corresponding basis vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="c1"># Clear previous plot items except axes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># Early exit if no unit cell selected</span>
        <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">=</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span>

        <span class="c1"># Collect line vertices</span>
        <span class="n">unique_edges</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># Unique edges to avoid duplication from neighboring unit cells</span>
        <span class="c1"># Loop over the unit cell indices</span>
        <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># List of tuples with vertices defining edges</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_unit_cell_edges</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ll</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                <span class="n">unique_edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>  <span class="c1"># Keep only unique edges</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sites</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ll</span><span class="p">)</span>

        <span class="c1"># Convert edges to line vertices</span>
        <span class="n">line_vertices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">unique_edges</span><span class="p">:</span>
            <span class="n">line_vertices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">])</span>
        <span class="c1"># Create the wireframe using GLLinePlotItem</span>
        <span class="n">unit_cell_edges</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">line_vertices</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span>  <span class="c1"># White color</span>
        <span class="p">)</span>

        <span class="c1"># Shift the unit cells so that they are centered around the origin</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">unit_cell_edges</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Plot the wireframe if requested</span>
        <span class="k">if</span> <span class="n">wireframe_shown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">unit_cell_edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="s2">&quot;unit_cell_edges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_cell_edges</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot all `Site`s within the `UnitCell` at (a1,a2,a3).</span>

<span class="sd">        Each site is represented as a colored sphere positioned according to</span>
<span class="sd">        its fractional coordinates within the unit cell. Sites can be selected</span>
<span class="sd">        and change size when highlighted. Spheres also store the site id</span>
<span class="sd">        to draw the coupling links when pairs of states are selected from</span>
<span class="sd">        the hopping panel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a1, a2, a3 : int</span>
<span class="sd">            Integer multiples of the unit cell basis vectors v1, v2, and v3.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Early exit if no unit cell or it contains no sites</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Extract basis vectors</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

        <span class="c1"># Plot each site as a sphere</span>
        <span class="k">for</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Calculate the position in Cartesian coordinates</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="p">(</span><span class="n">a2</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">c2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="p">(</span><span class="n">a3</span> <span class="o">+</span> <span class="n">site</span><span class="o">.</span><span class="n">c3</span><span class="p">)</span> <span class="o">*</span> <span class="n">v3</span>
            <span class="p">)</span>
            <span class="n">sphere_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">site_id</span><span class="p">]</span><span class="o">.</span><span class="n">color</span>

            <span class="n">sphere_radius</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">site_id</span><span class="p">]</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">DEFAULT_SITE_SCALING</span>
                <span class="k">if</span> <span class="n">site_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">site</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">site_id</span><span class="p">]</span><span class="o">.</span><span class="n">R</span>
            <span class="p">)</span>
            <span class="c1"># Create a sphere for the site.</span>
            <span class="n">sphere</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLMeshItem</span><span class="p">(</span>
                <span class="n">meshdata</span><span class="o">=</span><span class="n">gl</span><span class="o">.</span><span class="n">MeshData</span><span class="o">.</span><span class="n">sphere</span><span class="p">(</span>
                    <span class="n">rows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">sphere_radius</span>
                <span class="p">),</span>
                <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">sphere_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">sphere_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">sphere_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">sphere_color</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="n">shader</span><span class="o">=</span><span class="s2">&quot;shaded&quot;</span><span class="p">,</span>
                <span class="n">glOptions</span><span class="o">=</span><span class="s2">&quot;translucent&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Shift the objects so that the illustration is centered</span>
            <span class="c1"># at the origin</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span>
            <span class="n">sphere</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># Store site ID as user data for interaction</span>
            <span class="n">sphere</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="n">site_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;site_</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">a1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">a2</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">a3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_unit_cell_edges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the edges of the unit cell parallelepiped.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a1, a2, a3 : int</span>
<span class="sd">            Integer multiples of the unit cell basis vectors v1, v2, and v3.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[tuple[tuple[float, float, float], tuple[float, float, float]]]</span>
<span class="sd">            A list of edges in the unit cell parallelepiped.</span>
<span class="sd">            Each edge is represented as a tuple of two vertices.</span>
<span class="sd">            Each vertex is a tuple of three floats (x, y, z).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Extract basis vectors</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

        <span class="c1"># Define the 8 corners of the parallelepiped</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">v1</span><span class="p">,</span>
                <span class="n">v2</span><span class="p">,</span>
                <span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">,</span>  <span class="c1"># Bottom 4 vertices</span>
                <span class="n">v3</span><span class="p">,</span>
                <span class="n">v1</span> <span class="o">+</span> <span class="n">v3</span><span class="p">,</span>
                <span class="n">v2</span> <span class="o">+</span> <span class="n">v3</span><span class="p">,</span>
                <span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">v3</span><span class="p">,</span>  <span class="c1"># Top 4 vertices</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Shift the corners by the appropriate multiples of basis vectors</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">+</span> <span class="p">(</span><span class="n">a1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">]</span>
        <span class="c1"># Define the 12 edges of the parallelepiped</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>  <span class="c1"># Bottom square</span>
                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Top square</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Vertical edges</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Convert edges into line segments</span>
        <span class="n">vertex_tuples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">vert1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">verts</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">vert2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">verts</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">vertex_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">vert1</span><span class="p">,</span> <span class="n">vert2</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">vertex_tuples</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_hopping_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_selection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw segments to indicate hopping connections.</span>

<span class="sd">        When a pair is selected from the hopping matrix, this function</span>
<span class="sd">        draws lines starting from the site hosting the source state</span>
<span class="sd">        inside the unit cell around (0,0,0) to all the sites hosting</span>
<span class="sd">        the target sites.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pair_selection : tuple</span>
<span class="sd">            A tuple of (site_name, site_id, state_name, state_id)</span>
<span class="sd">            representing the selected pair of states.</span>
<span class="sd">            The first element is the source state and the second</span>
<span class="sd">            element is the target state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Clear previous hopping segments</span>
        <span class="n">hopping_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hopping_segments&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hopping_segments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">hopping_segments</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="s2">&quot;hopping_segments&quot;</span><span class="p">]</span>

        <span class="c1"># s1 and s2 are tuples (site_name, site_id, state_name, state_id)</span>
        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">pair_selection</span>
        <span class="n">hoppings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">s1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="c1"># Early exit if the states are not coupled</span>
        <span class="k">if</span> <span class="n">hoppings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Get the basis vectors</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

        <span class="c1"># Get the location of the source site in the (0,0,0) unit cell</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">source_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">c1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">c2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">c3</span> <span class="o">*</span> <span class="n">v3</span>

        <span class="c1"># Get the location of the target sites in the (0,0,0) unit cell</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">s1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">target_pos</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">c1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">c2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">c3</span> <span class="o">*</span> <span class="n">v3</span>

        <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Extract the displacements for the selected state pair</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hoppings</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target_pos</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">d3</span> <span class="o">*</span> <span class="n">v3</span>
            <span class="c1"># Sequentially append the source and the target for each</span>
            <span class="c1"># coupling segment</span>
            <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_pos</span><span class="p">)</span>
            <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="n">hopping_segments</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">segments</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">CF_YELLOW</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Shift so that the source state is in a unit cell at the origin</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v3</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">hopping_segments</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Add to the view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">hopping_segments</span><span class="p">)</span>
        <span class="c1"># Store it so we can remove it later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="s2">&quot;hopping_segments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hopping_segments</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.UnitCellPlotController.update_hopping_segments" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_hopping_segments</span><span class="p">(</span><span class="n">pair_selection</span><span class="p">)</span></code>

<a href="#TiBi.controllers.UnitCellPlotController.update_hopping_segments" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Draw segments to indicate hopping connections.</p>
<p>When a pair is selected from the hopping matrix, this function
draws lines starting from the site hosting the source state
inside the unit cell around (0,0,0) to all the sites hosting
the target sites.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pair_selection</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of (site_name, site_id, state_name, state_id)
representing the selected pair of states.
The first element is the source state and the second
element is the target state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/uc_plot_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_hopping_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_selection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw segments to indicate hopping connections.</span>

<span class="sd">    When a pair is selected from the hopping matrix, this function</span>
<span class="sd">    draws lines starting from the site hosting the source state</span>
<span class="sd">    inside the unit cell around (0,0,0) to all the sites hosting</span>
<span class="sd">    the target sites.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pair_selection : tuple</span>
<span class="sd">        A tuple of (site_name, site_id, state_name, state_id)</span>
<span class="sd">        representing the selected pair of states.</span>
<span class="sd">        The first element is the source state and the second</span>
<span class="sd">        element is the target state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Clear previous hopping segments</span>
    <span class="n">hopping_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hopping_segments&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hopping_segments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">hopping_segments</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="s2">&quot;hopping_segments&quot;</span><span class="p">]</span>

    <span class="c1"># s1 and s2 are tuples (site_name, site_id, state_name, state_id)</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">pair_selection</span>
    <span class="n">hoppings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">hoppings</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">s1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1"># Early exit if the states are not coupled</span>
    <span class="k">if</span> <span class="n">hoppings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># Get the basis vectors</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

    <span class="c1"># Get the location of the source site in the (0,0,0) unit cell</span>
    <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">source_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">c1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">c2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">c3</span> <span class="o">*</span> <span class="n">v3</span>

    <span class="c1"># Get the location of the target sites in the (0,0,0) unit cell</span>
    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">s1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">c1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">c2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">c3</span> <span class="o">*</span> <span class="n">v3</span>

    <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Extract the displacements for the selected state pair</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">),</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hoppings</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target_pos</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">d3</span> <span class="o">*</span> <span class="n">v3</span>
        <span class="c1"># Sequentially append the source and the target for each</span>
        <span class="c1"># coupling segment</span>
        <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_pos</span><span class="p">)</span>
        <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">hopping_segments</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span>
        <span class="n">pos</span><span class="o">=</span><span class="n">segments</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">CF_YELLOW</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Shift so that the source state is in a unit cell at the origin</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v3</span>
    <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">hopping_segments</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Add to the view</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">hopping_segments</span><span class="p">)</span>
    <span class="c1"># Store it so we can remove it later</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="s2">&quot;hopping_segments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hopping_segments</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="TiBi.controllers.UnitCellPlotController.update_unit_cell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_unit_cell</span><span class="p">(</span><span class="n">wireframe_shown</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span></code>

<a href="#TiBi.controllers.UnitCellPlotController.update_unit_cell" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Draw the selected <code>UnitCell</code> in the 3D view.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>wireframe_shown</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Denotes whether the primitive vector wireframe is drawn</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n1</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of repetitions along the corresponding basis vector</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n2</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of repetitions along the corresponding basis vector</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n3</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of repetitions along the corresponding basis vector</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>TiBi/controllers/uc_plot_controller.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_unit_cell</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">wireframe_shown</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">n1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n3</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the selected `UnitCell` in the 3D view.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wireframe_shown : bool</span>
<span class="sd">        Denotes whether the primitive vector wireframe is drawn</span>
<span class="sd">    n1, n2, n3 : int</span>
<span class="sd">        Number of repetitions along the corresponding basis vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">unit_cell</span>
    <span class="c1"># Clear previous plot items except axes</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="c1"># Early exit if no unit cell selected</span>
    <span class="k">if</span> <span class="n">uc_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cells</span><span class="p">[</span><span class="n">uc_id</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">=</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span>

    <span class="c1"># Collect line vertices</span>
    <span class="n">unique_edges</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">set</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># Unique edges to avoid duplication from neighboring unit cells</span>
    <span class="c1"># Loop over the unit cell indices</span>
    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="c1"># List of tuples with vertices defining edges</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_unit_cell_edges</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ll</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">unique_edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>  <span class="c1"># Keep only unique edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sites</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ll</span><span class="p">)</span>

    <span class="c1"># Convert edges to line vertices</span>
    <span class="n">line_vertices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">unique_edges</span><span class="p">:</span>
        <span class="n">line_vertices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">])</span>
    <span class="c1"># Create the wireframe using GLLinePlotItem</span>
    <span class="n">unit_cell_edges</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span>
        <span class="n">pos</span><span class="o">=</span><span class="n">line_vertices</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span>  <span class="c1"># White color</span>
    <span class="p">)</span>

    <span class="c1"># Shift the unit cells so that they are centered around the origin</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">-</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="mi">2</span>
    <span class="p">)</span>

    <span class="n">unit_cell_edges</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Plot the wireframe if requested</span>
    <span class="k">if</span> <span class="n">wireframe_shown</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_view</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">unit_cell_edges</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_plot_items</span><span class="p">[</span><span class="s2">&quot;unit_cell_edges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_cell_edges</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.instant", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>